  <!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>{% block title %}Ulysses CRM{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >

    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">

    <style>
      body.openhouse-public {
        background: #ffffff !important;
      }

      .content-panel {
        background-color: rgba(245, 246, 248, 0.96);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);
      }

      .contacts-table,
      .contacts-table thead th,
      .contacts-table tbody tr td {
        background-color: #ffffff !important;
      }

      .contacts-table tbody tr:hover td {
        background-color: #f7f7f7 !important;
      }

      .card-header {
        font-size: 0.95rem;
        font-weight: 600;
      }

      .card-soft {
        border-radius: 12px;
      }

      .card-soft .card-body {
        border-radius: 12px;
      }
    </style>

    {% block extra_head %}{% endblock %}
</head>

<body class="app-bg {% block body_class %}{% endblock %}">

{% set hide_nav = hide_nav|default(false) %}

{% if not hide_nav %}
<nav class="navbar navbar-expand-md navbar-light bg-white shadow-sm border-bottom sticky-top">
  <div class="container-fluid py-2" style="font-size: 0.9rem;">

    <a href="{{ url_for('dashboard') }}" class="navbar-brand d-flex align-items-center text-dark">
      <img
        src="{{ url_for('static', filename='ulysses-logo.svg') }}"
        alt="Ulysses CRM"
        style="height: 60px;"
        class="me-2"
      >
    </a>

    <button class="navbar-toggler" type="button"
            data-bs-toggle="collapse"
            data-bs-target="#mainNav"
            aria-controls="mainNav"
            aria-expanded="false"
            aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">
      <ul class="navbar-nav ms-0 ms-md-2 w-100 d-flex">

        <li class="nav-item">
          <a href="{{ url_for('dashboard') }}"
             class="nav-link {% if active_page == 'dashboard' %}fw-semibold{% endif %}">
            Dashboard
          </a>
        </li>


        <li class="nav-item">
          <a href="{{ url_for('contacts') }}"
             class="nav-link {% if active_page == 'contacts' %}fw-semibold{% endif %}">
            Contacts
          </a>
        </li>

        <li class="nav-item">
          <a href="{{ url_for('professionals') }}"
             class="nav-link {% if active_page == 'professionals' %}fw-semibold{% endif %}">
            Professionals
          </a>
        </li>

        <li class="nav-item">
          <a href="{{ url_for('tasks_list') }}"
             class="nav-link {% if active_page == 'tasks_list' %}fw-semibold{% endif %}">
            Tasks
          </a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('openhouse_list') }}">Open Houses</a>
        </li>

        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('templates_index') }}">Templates</a>
        </li>
        
      {% if current_user.is_authenticated and current_user.role == "owner" %}
        <li class="nav-item">
          <a class="nav-link {% if active_page == 'admin' %}fw-semibold{% endif %}"
             href="{{ url_for('admin_home') }}">
            Admin
          </a>
        </li>
      {% endif %}
        
        <li class="nav-item">
          <a class="nav-link" href="{{ calendar_feed_url }}" target="_blank">Calendar Feed</a>
        </li>
        {% if current_user.is_authenticated %}
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('account') }}">Account</a>
          </li>
        {% endif %}
        {% if current_user.is_authenticated %}
          <li class="nav-item ms-auto">
            <a class="nav-link text-danger" href="{{ url_for('logout') }}">Logout</a>
          </li>
        {% endif %}

      </ul>
    </div>
  </div>
</nav>
{% endif %}

{% if APP_ENV != "PROD" %}
  <div class="env-banner text-center py-1 small fw-semibold">
    ⚠️ LOCAL DEVELOPMENT ENVIRONMENT — NOT PRODUCTION
  </div>
{% endif %}

{% block flashes %}
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <div class="mb-2">
        {% for category, message in messages %}
          {% set bs = category %}
          {% if bs == "message" %}{% set bs = "info" %}{% endif %}
          {% if bs == "error" %}{% set bs = "danger" %}{% endif %}

          <div class="alert alert-{{ bs }} alert-dismissible fade show py-2 px-3 small mb-2" role="alert">
            {{ message }}
            <button type="button"
                    class="btn btn-sm btn-light rounded-circle ms-2 p-0"
                    style="width: 18px; height: 18px; line-height: 1;"
                    data-bs-dismiss="alert"
                    aria-label="Close">
              ×
            </button>
          </div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}
{% endblock %}

<div class="container py-4">
  {% block content %}{% endblock %}
</div>

<footer class="text-center text-muted py-3 small bg-white border-top">
  © {{ current_year }} Ithaca Enterprises. All rights reserved.
  <div class="text-muted small">
    Ulysses CRM v{{ APP_VERSION }}
    ·
    {% if APP_ENV == "PROD" %}
      <span class="fw-semibold text-success">PROD</span>
    {% else %}
      <span class="fw-semibold text-warning">LOCAL</span>
    {% endif %}
  </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  
{# Global modals and utilities that must exist on every page #}
{% block global_modals %}{% endblock %}

  <!-- Task Modal (global) -->
  <div class="modal fade" id="taskModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="taskModalTitle">Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body" id="taskModalBody">
          <div class="text-muted">Loading...</div>
        </div>
      </div>
    </div>
  </div>

<script src="{{ url_for('static', filename='js/task_form.js') }}"></script>

<script>
  async function openTaskModal(url, title) {
    const titleEl = document.getElementById("taskModalTitle");
    const bodyEl = document.getElementById("taskModalBody");
    const modalEl = document.getElementById("taskModal");

    if (!titleEl || !bodyEl || !modalEl) return;

    titleEl.textContent = title || "Task";
    bodyEl.innerHTML = `<div class="text-muted">Loading...</div>`;

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    try {
      const resp = await fetch(url, { credentials: "include" });

      if (!resp.ok) {
        bodyEl.innerHTML =
          `<div class="alert alert-danger mb-0">
             Could not load the task form (${resp.status}).
           </div>`;
        return;
      }

      const html = await resp.text();
      bodyEl.innerHTML = html;

      if (window.initTaskFormEnhancements) {
        window.initTaskFormEnhancements();
      }
    } catch (err) {
      bodyEl.innerHTML =
        `<div class="alert alert-danger mb-0">
           Could not load the task form.
         </div>`;
    }
  }
</script>
<script>
  function formatPhoneUS(value) {
    const digits = (value || "").replace(/\D/g, "");
    if (digits.length === 10) {
      return "(" + digits.slice(0, 3) + ") " + digits.slice(3, 6) + "-" + digits.slice(6);
    }
    return value;
  }

  document.addEventListener("blur", function (e) {
    const el = e.target;
    if (!el) return;
    if (el.classList && el.classList.contains("phone-input")) {
      el.value = formatPhoneUS(el.value);
    }
  }, true);
</script>

{# Global scripts that must exist on every page #}
{% block global_scripts %}
<script>
  async function openTaskModal(url, title) {
    const titleEl = document.getElementById("taskModalTitle");
    const bodyEl = document.getElementById("taskModalBody");
    const modalEl = document.getElementById("taskModal");

    if (!titleEl || !bodyEl || !modalEl) return;

    titleEl.textContent = title || "Task";
    bodyEl.innerHTML = `<div class="text-muted">Loading...</div>`;

    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();

    try {
      const resp = await fetch(url, { credentials: "include" });

      if (!resp.ok) {
        bodyEl.innerHTML =
          `<div class="alert alert-danger mb-0">
             Could not load the task form (${resp.status}).
           </div>`;
        return;
      }

      const html = await resp.text();
      bodyEl.innerHTML = html;

      if (window.initTaskFormEnhancements) {
        window.initTaskFormEnhancements();
      }
    } catch (err) {
      bodyEl.innerHTML =
        `<div class="alert alert-danger mb-0">
           Could not load the task form.
         </div>`;
    }
  }
</script>
{% endblock %}

{# Page-specific scripts (leave empty by default) #}
{% block extra_scripts %}{% endblock %}

</body>
</html>
