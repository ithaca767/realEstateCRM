{% extends "base.html" %}

{% block title %}
  {% if mode == "edit" %}Edit Transaction{% else %}New Transaction{% endif %}
{% endblock %}

{% block content %}
<div class="container py-4">

  <h3 class="mb-3">
    {% if mode == "edit" %}Edit Transaction{% else %}New Transaction{% endif %}
  </h3>

  <form method="post">
    {% if next_url %}
      <input type="hidden" name="next" value="{{ next_url }}">
    {% endif %}
 
    <div class="row mb-3">
      <div class="col-12">
        <label class="form-label">Address</label>
        <input
          type="text"
          class="form-control"
          name="address"
          value="{% if tx and tx.address %}{{ tx.address }}{% endif %}"
          placeholder="123 Main St, Keyport, NJ 07735"
        >
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Status</label>
        <select class="form-select" name="status" required>
          {% for value, label in transaction_statuses %}
            <option value="{{ value }}"
              {% if tx and tx.status == value %}selected{% endif %}>
              {{ label }}
            </option>
          {% endfor %}
        </select>
      </div>

      <div class="col-md-4">
        <label class="form-label">Transaction Type</label>
        <select class="form-select" name="transaction_type">
          <option value="buy" {% if tx and tx.transaction_type == "buy" %}selected{% endif %}>Buy</option>
          <option value="sell" {% if tx and tx.transaction_type == "sell" %}selected{% endif %}>Sell</option>
          <option value="rent" {% if tx and tx.transaction_type == "rent" %}selected{% endif %}>Rent</option>
          <option value="lease" {% if tx and tx.transaction_type == "lease" %}selected{% endif %}>Lease</option>
          <option value="unknown" {% if tx and tx.transaction_type == "unknown" %}selected{% endif %}>Unknown</option>
        </select>
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-3">
        <label class="form-label">List Price</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          name="list_price"
          value="{% if tx and tx.list_price is not none %}{{ tx.list_price }}{% endif %}"
          placeholder="0.00"
        >
      </div>

      <div class="col-md-3">
        <label class="form-label">Offer Price</label>
        <input
          type="number"
          step="0.01"
          class="form-control"
          name="offer_price"
          value="{% if tx and tx.offer_price is not none %}{{ tx.offer_price }}{% endif %}"
          placeholder="0.00"
        >
      </div>

      <div class="col-md-3">
        <label class="form-label">Expected Close Date</label>
        <input
          type="date"
          class="form-control"
          name="expected_close_date"
          value="{% if tx and tx.expected_close_date %}{{ tx.expected_close_date }}{% endif %}"
        >
      </div>

      <div class="col-md-3">
        <label class="form-label">Actual Close Date</label>
        <input
          type="date"
          class="form-control"
          name="actual_close_date"
          value="{% if tx and tx.actual_close_date %}{{ tx.actual_close_date }}{% endif %}"
        >
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-4">
        <label class="form-label">Attorney Review End</label>
        <input
          type="date"
          class="form-control"
          name="attorney_review_end_date"
          value="{% if tx and tx['attorney_review_end_date'] %}{{ tx['attorney_review_end_date'] }}{% endif %}"
        >
      </div>

      <div class="col-md-4">
        <label class="form-label">Inspection Deadline</label>
        <input
          type="date"
          class="form-control"
          name="inspection_deadline"
          value="{% if tx and tx['inspection_deadline'] %}{{ tx['inspection_deadline'] }}{% endif %}"
        >
      </div>

      <div class="col-md-4">
        <label class="form-label">Financing Contingency</label>
        <input
          type="date"
          class="form-control"
          name="financing_contingency_date"
          value="{% if tx and tx['financing_contingency_date'] %}{{ tx['financing_contingency_date'] }}{% endif %}"
        >
      </div>
    </div>

    <div class="row mb-3">
      <div class="col-md-6">
        <label class="form-label">Appraisal Deadline</label>
        <input
          type="date"
          class="form-control"
          name="appraisal_deadline"
          value="{% if tx and tx['appraisal_deadline'] %}{{ tx['appraisal_deadline'] }}{% endif %}"
        >
      </div>

      <div class="col-md-6">
        <label class="form-label">Mortgage Commitment</label>
        <input
          type="date"
          class="form-control"
          name="mortgage_commitment_date"
          value="{% if tx and tx['mortgage_commitment_date'] %}{{ tx['mortgage_commitment_date'] }}{% endif %}"
        >
      </div>
          <!-- Deadlines (Phase 3.1: read-only) -->
      <div class="card mt-4">
        <div class="card-header fw-semibold">
          Deadlines
        </div>
  
        <div class="card-body p-0">
          {% if deadlines and deadlines|length > 0 %}
            <div class="table-responsive">
              <table class="table mb-0">
                <thead>
                  <tr>
                    <th>Name</th>
                    <th>Due Date</th>
                    <th>Status</th>
                    <th>Notes</th>
                  </tr>
                </thead>
                <tbody>
                  {% for d in deadlines %}
                    <tr>
                      <td>{{ d['name'] }}</td>
                      <td>
                        {% if d['due_date'] %}
                          {{ d['due_date'] }}
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if d['is_done'] %}
                          <span class="badge bg-success">Done</span>
                        {% else %}
                          <span class="badge bg-secondary">Pending</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if d['notes'] %}
                          <span class="text-muted">{{ d['notes'] }}</span>
                        {% else %}
                          <span class="text-muted">—</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-3 text-muted">No deadlines yet.</div>
          {% endif %}
        </div>
      </div>

    </div>

    <div class="d-flex gap-2">
      <button type="submit" class="btn btn-primary">
        {% if mode == "edit" %}Save Changes{% else %}Create Transaction{% endif %}
      </button>

      {% if next_url %}
        <a href="{{ next_url }}" class="btn btn-secondary">Cancel</a>
      {% endif %}
    </div>
  </form>

</div>
{% endblock %}
