{% extends "base.html" %}
{% block content %}
{% set premium_active = premium_active|default(false) %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">Search</h2>
    <div class="text-muted">Search contacts, engagements, transactions, and professionals</div>
  </div>
</div>

<div class="card mt-3">
  <div class="card-body">
    <form method="GET" action="{{ url_for('global_search') }}">
      <div class="input-group">
        <input
          type="text"
          name="q"
          class="form-control"
          placeholder="Type to search"
          value="{{ q }}"
          autocomplete="off"
        />
        <button class="btn btn-primary" type="submit">Search</button>
      </div>
      <div class="text-muted small mt-2">Type at least 2 characters.</div>

      {% if ai and q and q|length >= 2 and (not ai_results or (not ai_results.contacts and not ai_results.engagements and not ai_results.transactions and not ai_results.professionals)) %}
        <div class="alert alert-warning mt-3 mb-0">
          AI broadening is on, but no AI matches were found. If this seems wrong, rebuild the AI index.
        </div>
      {% endif %}
			
      {% if q and q|length >= 2 %}
        {% set ai_panel_open = ai or answer %}
      
        <div class="mt-2">
          <button
            class="btn btn-sm btn-outline-primary"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#aiAssistPanel"
            aria-expanded="{{ 'true' if ai_panel_open else 'false' }}"
            aria-controls="aiAssistPanel"
          >
            AI Assist
            {% if ai or answer %}
              <span class="badge bg-primary-subtle text-dark border ms-2">On</span>
            {% endif %}
          </button>
      
          <div class="collapse {% if ai_panel_open %}show{% endif %} mt-2" id="aiAssistPanel">
            <div class="border rounded p-2 bg-light">
              <div class="d-flex flex-wrap gap-2">
      
                {% if not ai %}
                  <a class="btn btn-sm btn-outline-primary"
                     href="{{ url_for('global_search') }}?q={{ q|urlencode }}&ai=1{% if answer %}&answer=1{% endif %}">
                    Broaden with AI
                  </a>
                {% else %}
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('global_search') }}?q={{ q|urlencode }}{% if answer %}&answer=1{% endif %}">
                    AI Broadening is on (turn off)
                  </a>
                {% endif %}
      
                {% if premium_active %}
                  {% if not answer %}
                    <a class="btn btn-sm btn-outline-success"
                       href="{{ url_for('global_search') }}?q={{ q|urlencode }}{% if ai %}&ai=1{% endif %}&answer=1">
                      Answer with AI
                    </a>
                  {% else %}
                    <a class="btn btn-sm btn-outline-secondary"
                       href="{{ url_for('global_search') }}?q={{ q|urlencode }}{% if ai %}&ai=1{% endif %}">
                      AI Answer Mode is on (turn off)
                    </a>
                  {% endif %}
                {% else %}
                  <button class="btn btn-sm btn-outline-secondary" type="button" disabled>
                    Answer with AI (Premium)
                  </button>
                {% endif %}
      
                {% if current_user.id == 1 %}
                  <form method="POST" action="{{ url_for('admin_rebuild_search_index') }}" class="m-0">
                    <input type="hidden" name="q" value="{{ q }}">
                    <input type="hidden" name="ai" value="{{ '1' if ai else '' }}">
                    <button class="btn btn-sm btn-outline-secondary" type="submit">
                      Rebuild AI index
                    </button>
                  </form>
                {% endif %}
      
              </div>
      
              <div class="text-muted small mt-2">
                Use AI Assist to broaden matches. Premium enables grounded answers with citations.
              </div>
            </div>
          </div>
        </div>
      {% endif %}
      
    </form>
  </div>
</div>

{% if premium_active and answer and answer_result and q and q|length >= 2 %}
  <div class="card mt-3">
    <div class="card-header bg-success-subtle text-dark fw-semibold">
      AI Answer
    </div>
    <div class="card-body">
      {% if answer_result.no_answer %}
        <div class="text-muted">No grounded answer found in your CRM data.</div>
        {% if answer_result.warning %}
          <div class="alert alert-warning mt-2 mb-0">{{ answer_result.warning }}</div>
        {% endif %}
      {% else %}
        <div class="mb-2">{{ answer_result.answer }}</div>

        <div class="mt-2">
          <div class="small text-muted fw-semibold mb-1">Sources</div>
        
          <div class="d-flex flex-column gap-2 mt-2">
            {% for c in answer_result.citations %}
              <div class="border rounded p-2 bg-light">
                <div class="d-flex justify-content-between align-items-start gap-2">
                  <div class="fw-semibold small">
                    {% if c.url %}
                      <a href="{{ c.url }}">{{ c.label or (c.type ~ ' #' ~ c.id) }}</a>
                    {% else %}
                      {{ c.label or (c.type ~ ' #' ~ c.id) }}
                    {% endif %}
                  </div>
                  <span class="badge bg-secondary-subtle text-dark border">
                    {{ c.type }}
                  </span>
                </div>
          
                {% if c.snippet %}
                  <div class="text-muted small mt-1">
                    {{ c.snippet }}
                  </div>
                {% endif %}
              </div>
            {% endfor %}
          </div>
        </div>

        <div class="text-muted small mt-2">
          Confidence: {{ (answer_result.confidence * 100)|round|int }}
        </div>

        {% if answer_result.warning %}
          <div class="alert alert-warning mt-2 mb-0">{{ answer_result.warning }}</div>
        {% endif %}
      {% endif %}
    </div>
  </div>
{% endif %}

{% set has_valid_answer = premium_active and answer and answer_result and not answer_result.no_answer %}

{% if q and (results.contacts or results.engagements or results.transactions or results.professionals) %}

  <div class="card mt-3">
    <div class="card-header bg-primary-subtle text-dark fw-semibold">
      Results
    </div>
    <div class="card-body">

      {% if results.contacts %}
        <div class="fw-semibold mb-2">Contacts</div>
        <div class="list-group mb-3">
          {% for r in results.contacts %}
            <a class="list-group-item list-group-item-action" href="{{ r.url }}">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ r.label }}</div>
                <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
              </div>
              {% if r.snippet %}
                <div class="text-muted small mt-1">{{ r.snippet }}</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      {% if results.engagements %}
        <div class="fw-semibold mb-2">Engagements</div>
        <div class="list-group">
          {% for r in results.engagements %}
            {% if r.url %}
              <a class="list-group-item list-group-item-action" href="{{ r.url }}">
            {% else %}
              <div class="list-group-item">
            {% endif %}
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold">{{ r.label }}</div>
                  <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
                </div>
                {% if r.snippet %}
                  <div class="text-muted small mt-1">{{ r.snippet }}</div>
                {% endif %}
            {% if r.url %}
              </a>
            {% else %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}
			
			{% if results.transactions %}
			  <div class="fw-semibold mb-2">Transactions</div>
			  <div class="list-group mb-3">
			    {% for r in results.transactions %}
			      <a class="list-group-item list-group-item-action" href="{{ r.url }}">
			        <div class="d-flex justify-content-between">
			          <div class="fw-semibold">{{ r.label }}</div>
			          <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
			        </div>
			        {% if r.snippet %}
			          <div class="text-muted small mt-1">{{ r.snippet }}</div>
			        {% endif %}
			      </a>
			    {% endfor %}
			  </div>
			{% endif %}
		
			{% if results.professionals %}
		  <div class="fw-semibold mb-2">Professionals</div>
		  <div class="list-group mb-3">
		    {% for r in results.professionals %}
		      <a class="list-group-item list-group-item-action" href="{{ r.url }}">
		        <div class="d-flex justify-content-between">
		          <div class="fw-semibold">{{ r.label }}</div>
		          <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
		        </div>
		        {% if r.snippet %}
		          <div class="text-muted small mt-1">{{ r.snippet }}</div>
		        {% endif %}
		      </a>
		    {% endfor %}
		  </div>
		{% endif %}


    </div>
  </div>

{% elif q and q|length >= 2 and not has_valid_answer %}
  <div class="card mt-3">
    <div class="card-body">
      <div class="text-muted">No results.</div>
    </div>
  </div>
{% endif %}

{% if ai and ai_results and (ai_results.contacts or ai_results.engagements or ai_results.transactions or ai_results.professionals) %}
  <div class="card mt-3">
    <div class="card-header bg-info-subtle text-dark fw-semibold">
      AI Broadened Results
    </div>
    <div class="card-body">

      {% if ai_results.contacts %}
        <div class="fw-semibold mb-2">Contacts</div>
        <div class="list-group mb-3">
          {% for r in ai_results.contacts %}
            <a class="list-group-item list-group-item-action" href="{{ r.url }}">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ r.label }}</div>
                <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
              </div>
              {% if r.snippet %}
                <div class="text-muted small mt-1">{{ r.snippet }}</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      {% if ai_results.transactions %}
        <div class="fw-semibold mb-2">Transactions</div>
        <div class="list-group mb-3">
          {% for r in ai_results.transactions %}
            <a class="list-group-item list-group-item-action" href="{{ r.url }}">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ r.label }}</div>
                <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
              </div>
              {% if r.snippet %}
                <div class="text-muted small mt-1">{{ r.snippet }}</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      {% if ai_results.professionals %}
        <div class="fw-semibold mb-2">Professionals</div>
        <div class="list-group mb-3">
          {% for r in ai_results.professionals %}
            <a class="list-group-item list-group-item-action" href="{{ r.url }}">
              <div class="d-flex justify-content-between">
                <div class="fw-semibold">{{ r.label }}</div>
                <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
              </div>
              {% if r.snippet %}
                <div class="text-muted small mt-1">{{ r.snippet }}</div>
              {% endif %}
            </a>
          {% endfor %}
        </div>
      {% endif %}

      {% if ai_results.engagements %}
        <div class="fw-semibold mb-2">Engagements</div>
        <div class="list-group">
          {% for r in ai_results.engagements %}
            {% if r.url %}
              <a class="list-group-item list-group-item-action" href="{{ r.url }}">
            {% else %}
              <div class="list-group-item">
            {% endif %}
                <div class="d-flex justify-content-between">
                  <div class="fw-semibold">{{ r.label }}</div>
                  <div class="text-muted small">{{ "%.3f"|format(r.score) }}</div>
                </div>
                {% if r.snippet %}
                  <div class="text-muted small mt-1">{{ r.snippet }}</div>
                {% endif %}
            {% if r.url %}
              </a>
            {% else %}
              </div>
            {% endif %}
          {% endfor %}
        </div>
      {% endif %}

    </div>
  </div>
{% endif %}

{% endblock %}
