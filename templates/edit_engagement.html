{% extends "base.html" %}
{% block title %}View / Edit Engagement - Ulysses CRM{% endblock %}

{% block content %}
<div class="container py-4" style="max-width: 900px;">

  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">View / Edit Engagement</h2>
      <div class="text-muted small">Update the engagement details, notes, and transcript fields.</div>
    </div>
      <a class="btn btn-outline-secondary"
         href="{{ url_for('edit_contact', contact_id=e['contact_id']) }}#engagements">
        Back
      </a>
    </div>

  <div class="card">
    <div class="card-body bg-white">
      <form method="post">
        <input type="hidden" name="next" value="{{ next_url or next or (url_for('edit_contact', contact_id=e['contact_id']) ~ '#engagements') }}">
        <input type="hidden" name="return_tab" value="{{ return_tab }}">
        <input type="hidden" name="return_to" value="{{ return_to }}">
    <div id="engEditRoot" data-engagement-id="{{ e['id'] }}"></div>

        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label">Type</label>
            {% set t = e["engagement_type"] or "call" %}
            <select name="engagement_type" class="form-select" required>
              <option value="call" {{ "selected" if t=="call" else "" }}>Phone Call</option>
              <option value="text" {{ "selected" if t=="text" else "" }}>Text Message</option>
              <option value="email" {{ "selected" if t=="email" else "" }}>Email</option>
              <option value="meeting" {{ "selected" if t=="meeting" else "" }}>Meeting</option>
              <option value="open_house" {{ "selected" if t=="open_house" else "" }}>Open house</option>
              <option value="other" {{ "selected" if t=="other" else "" }}>Other</option>
            </select>
          </div>

          <div class="col-md-4">
            <label class="form-label">Occurred at</label>
            <input type="datetime-local"
                   name="occurred_at"
                   class="form-control"
                   value="{{ e['occurred_at'].strftime('%Y-%m-%dT%H:%M') if e['occurred_at'] else '' }}">
          </div>

          <div class="col-md-4">
            <label class="form-label">Outcome</label>
            <input name="outcome" class="form-control" value="{{ e['outcome'] or '' }}">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">Requires follow-up</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="requires_follow_up"
                     {% if e.get("requires_follow_up") %}checked{% endif %}>
              <label class="form-check-label">Yes</label>
            </div>
          </div>
          
          <div class="col-md-4">
            <label class="form-label">Follow-up due at</label>
            <input type="datetime-local"
                   name="follow_up_due_at"
                   class="form-control"
                   value="{{ e['follow_up_due_at'].strftime('%Y-%m-%dT%H:%M') if e.get('follow_up_due_at') else '' }}">
          </div>
          
          <div class="col-md-4">
            <label class="form-label">Follow-up completed</label>
            <div class="form-check">
              <input class="form-check-input" type="checkbox" name="follow_up_completed"
                     {% if e.get("follow_up_completed") %}checked{% endif %}>
              <label class="form-check-label">Done</label>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Notes</label>
            <textarea name="notes" class="form-control" rows="4">{{ e['notes'] or '' }}</textarea>
          </div>

          <div class="col-12">
            <label class="form-label">Transcript (raw)</label>
            <textarea name="transcript_raw" class="form-control" rows="6">{{ e['transcript_raw'] or '' }}</textarea>
          </div>
          
          <div class="col-12">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <button type="button" class="btn btn-outline-primary btn-sm" id="engAiSummarizeExistingBtn">
                AI Assist: Summarize this engagement
              </button>
              <span class="small text-muted" id="engAiExistingStatus" style="display:none;"></span>
            </div>
          
            <div class="card mt-3" id="engAiExistingPreviewCard" style="display:none;">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-start">
                  <div>
                    <h6 class="mb-1">AI Preview</h6>
                    <div class="small text-muted">Nothing is saved unless you paste it and click Save changes.</div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-secondary" id="engAiExistingCloseBtn">Close</button>
                </div>
          
                <hr>
          
                <div class="mb-3">
                  <div class="fw-semibold">One-Sentence Summary</div>
                  <div class="mt-1" id="engAiExistingOne" style="white-space:pre-wrap;"></div>
                  <div class="mt-2">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="engAiExistingCopyOneBtn">Copy</button>
                  </div>
                </div>
          
                <div class="mb-3">
                  <div class="fw-semibold">CRM Narrative Summary</div>
                  <div class="mt-1" id="engAiExistingNarr" style="white-space:pre-wrap;"></div>
                  <div class="mt-2 d-flex gap-2 flex-wrap">
                    <button type="button" class="btn btn-sm btn-outline-secondary" id="engAiExistingCopyNarrBtn">Copy</button>
                    <button type="button" class="btn btn-sm btn-primary" id="engAiExistingInsertNotesBtn">Insert into Notes</button>
                    <button type="button" class="btn btn-sm btn-outline-primary" id="engAiExistingInsertCleanBtn">Insert into Summary (clean)</button>
                  </div>
                </div>
          
                <div class="mb-0" id="engAiExistingFollowWrap" style="display:none;">
                  <div class="fw-semibold">Suggested Follow-Up Items</div>
                  <ul class="mt-2 mb-0" id="engAiExistingFollowList"></ul>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <label class="form-label">Summary (clean)</label>
            <textarea name="summary_clean" class="form-control" rows="5">{{ e['summary_clean'] or '' }}</textarea>
          </div>

          <div class="col-12 d-flex justify-content-end gap-2">
            <a class="btn btn-outline-secondary"
               href="{{ url_for('edit_contact', contact_id=e['contact_id']) }}#engagements">
              Cancel
            </a>
            <button class="btn btn-success" type="submit">Save changes</button>
          </div>
        </div>

      </form>
    </div>
  </div>

</div>

<script>
  (function () {
    const root = document.getElementById("engEditRoot");
    if (!root) return;

    const engagementId = parseInt(root.dataset.engagementId || "", 10);
    if (!engagementId) return;

    const btn = document.getElementById("engAiSummarizeExistingBtn");
    if (!btn) return;

    // Bind once
    if (btn.dataset.bound === "1") return;
    btn.dataset.bound = "1";

    const statusEl = document.getElementById("engAiExistingStatus");
    const previewCard = document.getElementById("engAiExistingPreviewCard");
    const closeBtn = document.getElementById("engAiExistingCloseBtn");

    const oneEl = document.getElementById("engAiExistingOne");
    const narEl = document.getElementById("engAiExistingNarr");

    const followWrap = document.getElementById("engAiExistingFollowWrap");
    const followList = document.getElementById("engAiExistingFollowList");

    const copyOneBtn = document.getElementById("engAiExistingCopyOneBtn");
    const copyNarBtn = document.getElementById("engAiExistingCopyNarrBtn");
    const insertNotesBtn = document.getElementById("engAiExistingInsertNotesBtn");
    const insertCleanBtn = document.getElementById("engAiExistingInsertCleanBtn");

    const notesField = document.querySelector('textarea[name="notes"]');
    const summaryCleanField = document.querySelector('textarea[name="summary_clean"]');

    function setStatus(msg, isError) {
      if (!statusEl) return;
      statusEl.style.display = "inline";
      statusEl.textContent = msg;
      statusEl.classList.toggle("text-danger", !!isError);
      statusEl.classList.toggle("text-muted", !isError);
    }

    function clearStatus() {
      if (!statusEl) return;
      statusEl.style.display = "none";
      statusEl.textContent = "";
      statusEl.classList.remove("text-danger");
      statusEl.classList.add("text-muted");
    }

    function showPreview() { if (previewCard) previewCard.style.display = "block"; }
    function hidePreview() { if (previewCard) previewCard.style.display = "none"; }

    function safeText(v) { return (v === null || v === undefined) ? "" : String(v); }

    function renderFollowups(items) {
      if (!followWrap || !followList) return;
      followList.innerHTML = "";
      if (!items || !Array.isArray(items) || items.length === 0) {
        followWrap.style.display = "none";
        return;
      }
      for (const item of items) {
        const li = document.createElement("li");
        li.textContent = safeText(item);
        followList.appendChild(li);
      }
      followWrap.style.display = "block";
    }

    async function copyToClipboard(text) {
      try {
        await navigator.clipboard.writeText(text);
        setStatus("Copied.", false);
        setTimeout(clearStatus, 1200);
      } catch {
        setStatus("Copy failed. You can manually select and copy.", true);
      }
    }

    function appendIntoField(field, text) {
      if (!field) return false;
      const insertText = (text || "").trim();
      if (!insertText) return false;

      const current = field.value || "";
      field.value = current.trim()
        ? current.replace(/\s*$/, "\n\n") + insertText
        : insertText;

      field.focus();
      return true;
    }

    async function summarizeExisting() {
      clearStatus();
      setStatus("Summarizingâ€¦", false);
      btn.disabled = true;

      try {
        const resp = await fetch("/api/ai/engagements/summarize", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ engagement_id: engagementId })
        });

        const data = await resp.json();

        if (!resp.ok || !data.ok) {
          const msg =
            (data && data.error && data.error.message) ||
            "AI summarization failed.";
          setStatus(msg, true);
          return;
        }

        const payload = data.data || {};
        const one = payload.one_sentence_summary || "";
        const narrative = payload.crm_narrative_summary || "";
        const followups = payload.suggested_follow_up_items || [];

        oneEl.textContent = safeText(one);
        narEl.textContent = safeText(narrative);
        renderFollowups(followups);

        showPreview();
        setStatus("Preview ready.", false);
      } catch {
        setStatus("Network error while summarizing.", true);
      } finally {
        btn.disabled = false;
      }
    }

    btn.addEventListener("click", summarizeExisting);

    if (closeBtn) closeBtn.addEventListener("click", hidePreview);
    if (copyOneBtn) copyOneBtn.addEventListener("click", () => copyToClipboard(oneEl.textContent || ""));
    if (copyNarBtn) copyNarBtn.addEventListener("click", () => copyToClipboard(narEl.textContent || ""));

    if (insertNotesBtn) {
      insertNotesBtn.addEventListener("click", () => {
        if (!notesField) return setStatus("Could not find Notes field.", true);
        if (appendIntoField(notesField, narEl.textContent || "")) {
          setStatus("Inserted into Notes. Click Save changes to persist.", false);
        }
      });
    }

    if (insertCleanBtn) {
      insertCleanBtn.addEventListener("click", () => {
        if (!summaryCleanField) return setStatus("Could not find Summary (clean) field.", true);
        if (appendIntoField(summaryCleanField, narEl.textContent || "")) {
          setStatus("Inserted into Summary (clean). Click Save changes to persist.", false);
        }
      });
    }
  })();
</script>

{% endblock %}
