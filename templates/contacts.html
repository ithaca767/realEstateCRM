{% extends "base.html" %}

{% block title %}Contacts - Ulysses CRM{% endblock %}

{% block content %}
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="mb-0">Contacts</h2>
        <div class="text-muted">
          {% if active_tab == "all" %}All Contacts{% endif %}
          {% if active_tab == "buyers" %}Buyers{% endif %}
          {% if active_tab == "sellers" %}Sellers{% endif %}
          {% if active_tab == "leads" %}Active Leads{% endif %}
          {% if active_tab == "past_clients" %}Past Clients{% endif %}
        </div>
      </div>
    
      <button
        type="button"
        class="btn btn-success"
        data-bs-toggle="modal"
        data-bs-target="#addContactModal"
      >
        + Add New Contact
      </button>
    </div>

  <!-- Contacts panel: tabs + search + table + pagination -->
  <div class="card mt-3">
    <div class="card-body">

      <!-- Tabs + search bar -->
      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <ul class="nav nav-tabs border-0">
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'all' %}active{% endif %}"
               href="{{ url_for('contacts', tab='all', q=search_query, page=1) }}">
              All
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'buyers' %}active{% endif %}"
               href="{{ url_for('contacts', tab='buyers', q=search_query, page=1) }}">
              Buyers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'sellers' %}active{% endif %}"
               href="{{ url_for('contacts', tab='sellers', q=search_query, page=1) }}">
              Sellers
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'leads' %}active{% endif %}"
               href="{{ url_for('contacts', tab='leads', q=search_query, page=1) }}">
              Leads
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link {% if active_tab == 'past_clients' %}active{% endif %}"
               href="{{ url_for('contacts', tab='past_clients', q=search_query, page=1) }}">
              Past Clients
            </a>
          </li>
        </ul>

        <!-- Search form -->
        <form class="d-flex ms-3"
              method="get"
              action="{{ url_for('contacts') }}">
          <input type="hidden" name="tab" value="{{ active_tab }}">
          <input type="hidden" name="page" value="1">
          <input
            class="form-control form-control-sm"
            type="search"
            name="q"
            placeholder="Search contacts"
            value="{{ search_query or '' }}"
            aria-label="Search"
          >
          <button class="btn btn-sm btn-outline-secondary ms-2" type="submit">
            Search
          </button>
        </form>
      </div>

      <!-- Info line -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <small class="text-muted">
          Showing page {{ page }} of {{ total_pages }}
          ({{ total_rows }} contact{{ '' if total_rows == 1 else 's' }})
        </small>
      </div>

      <!-- Contacts table -->
      <div class="table-responsive">
        <table class="table table-hover table-sm mb-0 align-middle contacts-table">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Type</th>
              <th>Notes</th>
              <th></th>
            </tr>
          </thead>
          <tbody>
          {% if contacts %}
            {% for c in contacts %}
              {% set full_name = c["name"] or ((c["first_name"] or '') ~ ' ' ~ (c["last_name"] or '')) %}
              <tr>
                <td>{{ full_name or 'Untitled' }}</td>
                <td>{{ c["email"] }}</td>
                <td>{{ c["phone"] }}</td>
                <td>
                  {{ c["lead_type"] or '' }}
                  {% if c["pipeline_stage"] %}
                    <br><small class="text-muted">{{ c["pipeline_stage"] }}</small>
                  {% endif %}
                </td>
                <td class="text-truncate" style="max-width: 250px;">
                  {{ c["notes"] }}
                </td>
              <td class="text-end">
                <a href="{{ url_for('edit_contact', contact_id=c['id']) }}#engagements"
                   class="btn btn-sm btn-primary">
                  Open
                </a>
              </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="6" class="text-center py-3 text-muted">
                No contacts found.
              </td>
            </tr>
          {% endif %}
          </tbody>
        </table>
      </div>

      <!-- Pagination -->
      {% if total_pages > 1 %}
      <nav aria-label="Contacts pagination" class="mt-3 mb-0">
        <ul class="pagination justify-content-center mb-0">

          <!-- Previous -->
          <li class="page-item {% if page <= 1 %}disabled{% endif %}">
            <a class="page-link"
               href="{% if page > 1 %}{{ url_for('contacts', tab=active_tab, q=search_query, page=page-1) }}{% else %}#{% endif %}">
              Previous
            </a>
          </li>

          {% set start_page = page - 2 if page - 2 > 1 else 1 %}
          {% set end_page = page + 2 if page + 2 < total_pages else total_pages %}

          {% for p in range(start_page, end_page + 1) %}
            <li class="page-item {% if p == page %}active{% endif %}">
              <a class="page-link"
                 href="{{ url_for('contacts', tab=active_tab, q=search_query, page=p) }}">
                {{ p }}
              </a>
            </li>
          {% endfor %}

          <!-- Next -->
          <li class="page-item {% if page >= total_pages %}disabled{% endif %}">
            <a class="page-link"
               href="{% if page < total_pages %}{{ url_for('contacts', tab=active_tab, q=search_query, page=page+1) }}{% else %}#{% endif %}">
              Next
            </a>
          </li>
        </ul>
      </nav>
      {% endif %}

    </div>
  </div>

</div>

<!-- Add Contact Modal -->
<div class="modal fade" id="addContactModal" tabindex="-1" aria-labelledby="addContactModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title" id="addContactModalLabel">Add New Contact</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" action="{{ url_for('add_contact') }}">
        <div class="modal-body">
          <div class="row g-3">

            <div class="col-md-3">
              <label class="form-label">First Name *</label>
              <input name="first_name" class="form-control" required>
            </div>
            <div class="col-md-3">
              <label class="form-label">Last Name</label>
              <input name="last_name" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Email</label>
              <input name="email" type="email" class="form-control">
            </div>
            <div class="col-md-3">
              <label class="form-label">Phone</label>
              <input name="phone" class="form-control">
            </div>

            <div class="col-md-3">
              <label class="form-label">Lead Type</label>
              <select name="lead_type" class="form-select">
                <option value="">Select...</option>
                {% for t in lead_types %}
                  <option value="{{ t }}">{{ t }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Pipeline Stage</label>
              <select name="pipeline_stage" class="form-select">
                <option value="">Select...</option>
                {% for s in pipeline_stages %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Priority</label>
              <select name="priority" class="form-select">
                <option value="">Select...</option>
                {% for p in priorities %}
                  <option value="{{ p }}">{{ p }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label">Source</label>
              <select name="source" class="form-select">
                <option value="">Select...</option>
                {% for s in sources %}
                  <option value="{{ s }}">{{ s }}</option>
                {% endfor %}
              </select>
            </div>

            <!-- Current address -->
            <div class="col-12 mt-3">
              <h6 class="fw-bold mb-2">Current Address</h6>
            </div>

            <div class="col-md-6">
              <label class="form-label">Street Address</label>
              <input name="current_address" class="form-control" placeholder="123 Main St">
            </div>

            <div class="col-md-2 col-6">
              <label class="form-label">City</label>
              <input name="current_city" class="form-control" placeholder="Keyport">
            </div>
            <div class="col-md-2 col-3">
              <label class="form-label">State</label>
              <input name="current_state" class="form-control" placeholder="NJ">
            </div>
            <div class="col-md-2 col-3">
              <label class="form-label">ZIP</label>
              <input name="current_zip" class="form-control" placeholder="07735">
            </div>

            <div class="col-md-3">
              <label class="form-label">Last Contacted</label>
              <input name="last_contacted" type="date" class="form-control" value="{{ today }}">
            </div>
            <div class="col-md-3">
              <label class="form-label">Next Follow Up (Date)</label>
              <input name="next_follow_up" type="date" class="form-control">
            </div>

            <!-- Follow up time section with border and heading -->
            <div class="col-12 mt-3 pt-3 border-top">
              <h6 class="fw-bold mb-2">Next Follow Up Time</h6>
              <small class="text-muted">
                Optional time for your reminder.
              </small>
            </div>

            <div class="col-12">
              <div id="followupTimeRow" class="row g-2 mt-1" style="display: none;">
                <div class="col-md-2 col-4">
                  <label class="form-label">Hour</label>
                  <select name="next_follow_up_hour" class="form-select">
                    <option value="">HH</option>
                    {% for h in range(1,13) %}
                      <option value="{{ h }}">{{ h }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2 col-4">
                  <label class="form-label">Minute</label>
                  <select name="next_follow_up_minute" class="form-select">
                    <option value="">MM</option>
                    {% for m in ["00", "15", "30", "45"] %}
                      <option value="{{ m }}">{{ m }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-2 col-4">
                  <label class="form-label">AM / PM</label>
                  <select name="next_follow_up_ampm" class="form-select">
                    <option value="">AM / PM</option>
                    <option value="AM">AM</option>
                    <option value="PM">PM</option>
                  </select>
                </div>
              </div>
            </div>

            <div class="col-12 mt-3">
              <label class="form-label">Notes</label>
              <textarea
                name="notes"
                class="form-control"
                rows="2"
                placeholder="Motivation, timing, specific needs..."
              ></textarea>
            </div>

          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal"
          >
            Cancel
          </button>
          <button class="btn btn-success" type="submit">
            Add Contact
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var modal = document.getElementById("addContactModal");
    if (!modal) return;

    var dateInput = modal.querySelector('input[name="next_follow_up"]');
    var timeRow = document.getElementById("followupTimeRow");
    var hourSelect = modal.querySelector('select[name="next_follow_up_hour"]');
    var minuteSelect = modal.querySelector('select[name="next_follow_up_minute"]');
    var ampmSelect = modal.querySelector('select[name="next_follow_up_ampm"]');

    if (!dateInput || !timeRow) return;

    function toggleTimeRow() {
      if (dateInput.value) {
        timeRow.style.display = "";
      } else {
        timeRow.style.display = "none";
        if (hourSelect) hourSelect.value = "";
        if (minuteSelect) minuteSelect.value = "";
        if (ampmSelect) ampmSelect.value = "";
      }
    }

    // Run once on load
    toggleTimeRow();

    // Update when date changes
    dateInput.addEventListener("change", toggleTimeRow);

    // Also reset when modal is closed
    modal.addEventListener("hidden.bs.modal", function () {
      if (dateInput) dateInput.value = "";
      toggleTimeRow();
    });
  });
</script>
{% endblock %}
