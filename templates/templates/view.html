{% extends "base.html" %}
{% block content %}

<!-- Page header (Contacts style) -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">{{ t.title }}</h2>
    <div class="text-muted">
      <span class="me-2"><strong>Category:</strong> {{ t.category }}</span>
      <span class="me-2"><strong>Delivery:</strong> {{ t.delivery_type }}</span>
      {% if t.is_locked %}
        <span class="badge bg-success">Locked</span>
      {% else %}
        <span class="badge bg-secondary">Draft</span>
      {% endif %}
    </div>
  </div>

  <div class="d-flex gap-2">
    {% if not t.is_locked %}
      <a class="btn btn-sm btn-outline-primary" href="{{ url_for('templates_edit', template_id=t.id) }}">
        Edit
      </a>

      <form method="post" action="{{ url_for('templates_lock', template_id=t.id) }}">
        <button class="btn btn-sm btn-success" type="submit">Lock</button>
      </form>
    {% endif %}

    <form method="post" action="{{ url_for('templates_duplicate', template_id=t.id) }}">
      <button class="btn btn-sm btn-outline-secondary" type="submit">Duplicate</button>
    </form>

    <a class="btn btn-sm btn-outline-secondary" href="{{ url_for('templates_index') }}">Back</a>
  </div>
</div>

<!-- Main panel card (Contacts style) -->
<div class="card mt-3">
  <div class="card-body">

    <!-- Tabs-style row (visual consistency, not actual nav) -->
    <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
      <div class="fw-semibold">Template Content</div>
      <div class="small text-muted">
        Allowed tokens:
        <code>{{"{{client_name}}"}}</code>,
        <code>{{"{{agent_name}}"}}</code>,
        <code>{{"{{brokerage_footer}}"}}</code>
      </div>
    </div>

		<div class="card mt-3">
		  <div class="card-body">
		    <div class="d-flex justify-content-between align-items-center">
		      <div>
		        <div class="fw-semibold">Preview with Contact</div>
		        <div class="text-muted small">Select a contact to populate {{'{{client_name}}'}} in the preview.</div>
		      </div>
				<div style="min-width: 360px;">
				  <div class="position-relative">
				    <input id="contactSearch"
				           class="form-control form-control-sm"
				           type="search"
				           placeholder="Type a contact name (2+ chars)"
				           autocomplete="off">
				
				    <div id="contactResults"
				         class="list-group position-absolute w-100 shadow-sm"
				         style="top: 100%; left: 0; max-height: 260px; overflow-y: auto; z-index: 1050;">
				    </div>
				  </div>
				</div>
		  </div>
		</div>

    <div class="row g-3">
      <!-- Left: Raw + Notes -->
      <div class="col-lg-6">
        <div class="card card-soft">
          <div class="card-header bg-white">
            Raw Template
          </div>
          <div class="card-body">
            <pre id="rawBody" class="mb-3" style="white-space: pre-wrap;">{{ t.body }}</pre>
            <button class="btn btn-sm btn-primary" type="button" onclick="copyText('rawBody')">Copy raw</button>
          </div>
        </div>

        <div class="card card-soft mt-3">
          <div class="card-header bg-white">
            Internal Notes
          </div>
          <div class="card-body">
            {% if t.notes %}
              <pre class="mb-0" style="white-space: pre-wrap;">{{ t.notes }}</pre>
            {% else %}
              <div class="text-muted">No internal notes.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <!-- Right: Preview -->
      <div class="col-lg-6">
        <div class="card card-soft">
					<div class="card-header bg-white d-flex justify-content-between align-items-center">
					  {% if selected_contact %}
					    <div>
								<span class="fw-semibold">Previewing as:</span>
								<span class="fw-semibold text-primary">{{ selected_contact.name }}</span>
					    </div>
					    <a class="btn btn-sm btn-outline-secondary"
					       href="{{ url_for('templates_view', template_id=t.id) }}">
					      Clear
					    </a>
					  {% else %}
					    <span class="fw-semibold">Preview</span>
					    <span class="small text-muted">Safe sample values</span>
					  {% endif %}
					</div>
          <div class="card-body">
            <pre id="previewBody" class="mb-3" style="white-space: pre-wrap;">{{ preview }}</pre>
            <button class="btn btn-sm btn-outline-primary" type="button" onclick="copyText('previewBody')">
              Copy preview
            </button>
            <div class="small text-muted mt-2">
              Preview uses: “Client Name”, your user name (if available), and your brokerage footer block.
            </div>
          </div>
        </div>

        <!-- Quick actions callout -->
        <div class="alert alert-light border mt-3 mb-0">
          <div class="fw-semibold mb-1">Workflow</div>
          <div class="small text-muted">
            Draft templates can be edited. Locked templates are read-only. Duplicate creates an editable copy.
          </div>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
function copyText(elementId) {
  const el = document.getElementById(elementId);
  const text = el ? el.innerText : "";
  navigator.clipboard.writeText(text);
}
</script>
<script>
(function () {
  const input = document.getElementById("contactSearch");
  const results = document.getElementById("contactResults");
  if (!input || !results) return;

  let timer = null;

  function clearResults() {
    results.innerHTML = "";
  }

  function render(items) {
    clearResults();
    if (!items || items.length === 0) return;

    items.forEach(item => {
      const a = document.createElement("button");
      a.type = "button";
      a.className = "list-group-item list-group-item-action";
      a.innerHTML = `<div class="fw-semibold">${escapeHtml(item.name)}</div>
                     <div class="small text-muted">${escapeHtml(item.email || "")}</div>`;
      a.addEventListener("click", () => {
        const url = new URL(window.location.href);
        url.searchParams.set("contact_id", item.id);
        window.location.href = url.toString();
      });
      results.appendChild(a);
    });
  }

  function escapeHtml(str) {
    return (str || "").replace(/[&<>"']/g, m => ({
      "&": "&amp;", "<": "&lt;", ">": "&gt;", '"': "&quot;", "'": "&#039;"
    }[m]));
  }

  async function search(q) {
    const resp = await fetch(`/api/contacts/search?q=${encodeURIComponent(q)}`, { credentials: "include" });
    if (!resp.ok) return [];
    return await resp.json();
  }

  input.addEventListener("input", () => {
    const q = (input.value || "").trim();
    clearTimeout(timer);

    if (q.length < 2) {
      clearResults();
      return;
    }

    timer = setTimeout(async () => {
      try {
        const items = await search(q);
        render(items);
      } catch (e) {
        clearResults();
      }
    }, 200);
  });

  document.addEventListener("click", (e) => {
    if (!results.contains(e.target) && e.target !== input) {
      clearResults();
    }
  });
})();
</script>

{% endblock %}
