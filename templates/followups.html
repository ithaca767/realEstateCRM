{% extends "base.html" %}

{% block title %}Follow Ups â€“ Ulysses CRM{% endblock %}

{% block content %}

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Follow-ups</h2>
      <div class="text-muted">Today: {{ today }}</div>
    </div>
  </div>

  {% macro followup_table(rows) %}
    {% if rows and rows|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Name</th>
              <th>Date</th>
              <th>Time</th>
              <th>Stage</th>
              <th>Priority</th>
              <th>Area</th>
              <th style="width: 140px;" class="actions-col">Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for c in rows %}
              <tr>
                <td>
                  <a href="{{ url_for('edit_engagement', engagement_id=c['engagement_id'], next=url_for('edit_contact', contact_id=c['contact_id']) ~ '#engagements') }}">
                    {% if c["first_name"] or c["last_name"] %}
                      {{ (c["first_name"] or "") ~ (" " if c["first_name"] and c["last_name"] else "") ~ (c["last_name"] or "") }}
                    {% else %}
                      {{ c["name"] or "Unnamed Contact" }}
                    {% endif %}
                  </a>
                </td>
                <!-- <td>{{ c["next_follow_up"] or "" }}</td>
                <td>{{ c["next_follow_up_time"] or "" }}</td> -->
                <td>{{ c["pipeline_stage"] or "" }}</td>
                <td>{{ c["priority"] or "" }}</td>
                <td>{{ c["target_area"] or "" }}</td>
                <td>
                  <a class="btn btn-sm btn-outline-primary"
                     href="{{ url_for('edit_engagement', engagement_id=row['engagement_id'], return_to='contact', return_tab='engagements') }}">
                    Open
                  </a>
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mb-0 text-muted">Nothing here.</p>
    {% endif %}
  {% endmacro %}

  <!-- Content card -->
  <div class="card mt-3">
    <div class="card-body">

      <!-- Overdue -->
      <div class="card mb-3">
        <div class="card-header bg-danger-subtle text-dark fw-semibold">
          Overdue Follow Ups
        </div>
        <div class="card-body bg-white">
          {{ followup_table(overdue) }}
        </div>
      </div>

      <!-- Today -->
      <div class="card mb-3">
        <div class="card-header bg-warning-subtle text-dark fw-semibold">
          Today
        </div>
        <div class="card-body bg-white">
          {{ followup_table(today_list) }}
        </div>
      </div>

      <!-- Upcoming -->
      <div class="card">
        <div class="card-header bg-success-subtle text-dark fw-semibold">
          Upcoming
        </div>
        <div class="card-body bg-white">
          {{ followup_table(upcoming) }}
        </div>
      </div>

    </div>
  </div>

{% endblock %}
