{% extends "base.html" %}
{% block title %}Tasks{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <div>
    <h2 class="mb-0">Tasks</h2>
    <div class="text-muted small">
      {% if status %}
        Filtered: {{ status|replace('_',' ')|title }}
      {% else %}
        All tasks
      {% endif %}
    </div>
  </div>

  <button
    type="button"
    class="btn btn-success"
    onclick="openTaskModal('{{ url_for('tasks_modal_new') }}', 'New Task')">
    + Add New Task
  </button>
</div>

<div class="card mt-3">
  <div class="card-body">

    {% set current_status = (status or 'all') %}
    
    <div class="d-flex flex-wrap gap-2 mb-3">
      <a class="btn btn-sm {% if current_status == 'all' %}btn-dark{% else %}btn-outline-dark{% endif %}"
         href="{{ url_for('tasks_list', status='all') }}">All</a>
    
      {% for s in statuses %}
        <a class="btn btn-sm {% if current_status == s %}btn-dark{% else %}btn-outline-dark{% endif %}"
           href="{{ url_for('tasks_list', status=s) }}">{{ s|replace('_',' ')|title }}</a>
      {% endfor %}
    </div>

    {% if tasks and tasks|length > 0 %}
      <div class="table-responsive">
        <table class="table table-sm table-striped mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Title</th>
              <th class="d-none d-md-table-cell" style="width: 14%;">Status</th>
              <th class="d-none d-md-table-cell" style="width: 16%;">Due</th>
              <th style="width: 20%;" class="text-end actions-col">Actions</th>
            </tr>
          </thead>

          <tbody>
            {% for t in tasks %}
              <tr class="{% if t.is_overdue %}task-overdue{% endif %}">
                <td>
                  <div class="fw-semibold">
                    <button
                      type="button"
                      class="btn btn-link p-0 fw-semibold text-start text-decoration-none"
                      onclick="openTaskModal('{{ url_for('tasks_modal_edit', task_id=t.id) }}', 'Edit Task')">
                      {{ t.title }}
                    </button>
                  </div>

                  {% if t.description %}
                    {% set full = t.description|string %}
                    {% set is_long = (full|length > 220) %}
                  
                    <div class="d-none d-md-block mt-1">
                      <div id="taskDescDesktop_{{ t.id }}"
                           class="task-desc text-muted small {% if is_long %}is-clamped clamp-3{% endif %}">
                        {{ full }}
                      </div>
                  
                      {% if is_long %}
                        <button type="button"
                                class="btn btn-link p-0 text-decoration-none task-see-more"
                                data-desc-toggle="1"
                                data-target="taskDescDesktop_{{ t.id }}">
                          See more
                        </button>
                      {% endif %}
                    </div>
                  {% endif %}                  <div class="d-md-none mt-2">
                  
                    {% set badge_class = "bg-secondary" %}
                    {% if t.status == "open" %}{% set badge_class = "bg-primary" %}{% endif %}
                    {% if t.status == "completed" %}{% set badge_class = "bg-success" %}{% endif %}
                    {% if t.status == "snoozed" %}{% set badge_class = "bg-warning text-dark" %}{% endif %}
                    {% if t.status == "canceled" %}{% set badge_class = "bg-secondary" %}{% endif %}
                  
                    <div class="small">
                      <span class="badge {{ badge_class }}">
                        {{ t.status|replace('_',' ')|title }}
                      </span>

                      {% if t.is_overdue %}
                        <div class="mt-1">
                          <span class="badge bg-danger-subtle text-danger-emphasis">Overdue</span>
                        </div>
                      {% endif %}                  
                      
                      <span class="text-muted ms-2">
                        Due:
                        {% if t.due_at %}
                          {{ t.due_at|fmt_dt }}
                        {% elif t.due_date %}
                          {{ t.due_date|fmt_date }}
                        {% else %}
                          —
                        {% endif %}
                      </span>
                    </div>
                  
                    {% if t.description %}
                      {% set full = t.description|string %}
                      {% set is_long = (full|length > 140) %}
                  
                      <div class="mt-2 small text-muted">
                        <div id="taskDesc_{{ t.id }}" class="task-desc {% if is_long %}is-clamped{% endif %}">
                          {{ full }}
                        </div>
                  
                        {% if is_long %}
                        <button type="button"
                                class="btn btn-link p-0 text-decoration-none task-see-more"
                                data-desc-toggle="1"
                                data-target="taskDescDesktop_{{ t.id }}">
                          See more
                        </button>
                        {% endif %}
                      </div>
                    {% endif %}
                  
                  </div>

                  {% if t.contact_id %}
                    <div class="small text-muted">
                      Contact:
                      <a href="{{ url_for('edit_contact', contact_id=t.contact_id) }}">
                        {{ contact_map.get(t.contact_id|int, "Contact #" ~ t.contact_id) }}
                      </a>
                    </div>
                  {% endif %}
                </td>

                <td class="d-none d-md-table-cell">
                  {% set badge_class = "bg-secondary" %}
                  {% if t.status == "open" %}{% set badge_class = "bg-primary" %}{% endif %}
                  {% if t.status == "completed" %}{% set badge_class = "bg-success" %}{% endif %}
                  {% if t.status == "snoozed" %}{% set badge_class = "bg-warning text-dark" %}{% endif %}
                  {% if t.status == "snoozed" and t.snoozed_until %}
                    <div class="text-muted small">Until {{ t.snoozed_until|fmt_dt }}</div>
                  {% endif %}
                  {% if t.status == "canceled" %}{% set badge_class = "bg-secondary" %}{% endif %}

                  <span class="badge {{ badge_class }}">
                    {{ t.status|replace('_',' ')|title }}
                  </span>
                </td>

                <td class="d-none d-md-table-cell">
                  {% if t.due_at %}
                    <div>{{ t.due_at|fmt_dt }}</div>
                  {% elif t.due_date %}
                    <div>{{ t.due_date|fmt_date }}</div>
                  {% else %}
                    <div class="text-muted">—</div>
                  {% endif %}
                
                  {% if t.is_overdue %}
                    <div class="mt-1">
                      <span class="badge bg-danger-subtle text-danger-emphasis">Overdue</span>
                    </div>
                  {% endif %}
                </td>
                <td class="text-end">
                  <div class="d-inline-flex align-items-center justify-content-end">
                    <div class="btn-group btn-group-sm" role="group" aria-label="Task actions">
                      <button
                        type="button"
                        class="btn btn-outline-primary"
                        onclick="openTaskModal('{{ url_for('tasks_modal_edit', task_id=t.id) }}', 'Edit Task')">
                        Edit
                      </button>
                
                      {% if t.status != 'completed' and t.status != 'canceled' %}
                        <button
                          type="button"
                          class="btn btn-outline-success"
                          onclick="document.getElementById('taskCompleteForm_{{ t.id }}').submit();">
                          Complete
                        </button>
                      {% endif %}
                
                      <div class="btn-group btn-group-sm" role="group">
                        <button type="button"
                                class="btn btn-outline-secondary dropdown-toggle"
                                data-bs-toggle="dropdown"
                                aria-expanded="false">
                          More
                        </button>
                
                        <ul class="dropdown-menu dropdown-menu-end">
                
                          {% if t.status in ['open', 'snoozed'] %}
                            <li>
                              <button type="button" class="dropdown-item" onclick="openSnoozeModal({{ t.id }})">
                                Snooze...
                              </button>
                            </li>
                          {% endif %}
                
                          {% if t.status in ['open', 'snoozed'] %}
                            <li><hr class="dropdown-divider"></li>
                            <li>
                              <form method="post"
                                    action="{{ url_for('tasks_cancel', task_id=t.id) }}"
                                    onsubmit="return confirm('Cancel this task? This cannot be undone.');">
                                <button type="submit" class="dropdown-item text-danger">Cancel Task</button>
                              </form>
                            </li>
                          {% endif %}
                
                          {% if t.status in ['completed', 'canceled'] %}
                            <li>
                              <form method="post" action="{{ url_for('tasks_reopen', task_id=t.id) }}">
                                <button type="submit" class="dropdown-item">Reopen</button>
                              </form>
                            </li>
                          {% endif %}
                
                        </ul>
                      </div>
                    </div>
                
                    {% if t.status != 'completed' and t.status != 'canceled' %}
                      <form id="taskCompleteForm_{{ t.id }}"
                            method="post" 
                            action="{{ url_for('tasks_complete', task_id=t.id) }}"
                            class="d-none">
                      </form>
                    {% endif %}
                  </div>
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    {% else %}
      <div class="text-muted">No tasks yet.</div>
    {% endif %}

  </div>
</div>

<div class="modal fade" id="snoozeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form method="post" id="snoozeForm" action="">
        <div class="modal-header">
          <h5 class="modal-title">Snooze Task</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <label class="form-label" for="snoozed_until">Snoozed until</label>
          <input class="form-control" type="datetime-local" id="snoozed_until" name="snoozed_until" required>
          <div class="form-text">Choose a date and time to snooze until.</div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Snooze</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %} {# closes content #}

{% block extra_scripts %}
<script>
  function openSnoozeModal(taskId) {
    // Close task modal if open
    const taskModalEl = document.getElementById("taskModal");
    if (taskModalEl) {
      const taskModal = bootstrap.Modal.getInstance(taskModalEl);
      if (taskModal) {
        taskModal.hide();
      }
    }

    const form = document.getElementById("snoozeForm");
    if (!form) return;
    form.action = "/tasks/" + taskId + "/snooze";

    const input = document.getElementById("snoozed_until");
    if (input) {
      const d = new Date();
      d.setDate(d.getDate() + 1);
      d.setHours(9, 0, 0, 0);

      const pad = (n) => String(n).padStart(2, "0");
      input.value =
        d.getFullYear() + "-" +
        pad(d.getMonth() + 1) + "-" +
        pad(d.getDate()) + "T" +
        pad(d.getHours()) + ":" +
        pad(d.getMinutes());
    }

    const modalEl = document.getElementById("snoozeModal");
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  }
</script>

<script>
document.addEventListener("click", function (e) {
  const btn = e.target.closest('[data-desc-toggle="1"]');
  if (!btn) return;

  const id = btn.getAttribute("data-target");
  const el = document.getElementById(id);
  if (!el) return;

  if (el.classList.contains("is-clamped") || el.classList.contains("is-clamped-4")) {
    el.classList.remove("is-clamped");
    el.classList.remove("is-clamped-4");
    btn.textContent = "See less";
  } else {
    // Restore appropriate clamp type
    if (el.classList.contains("task-desc-desktop")) {
      el.classList.add("is-clamped-4");
    } else {
      el.classList.add("is-clamped");
    }
    btn.textContent = "See more";
  }
});
</script>

{% endblock %}
