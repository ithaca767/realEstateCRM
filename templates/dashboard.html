{% extends "base.html" %}

{% block title %}Dashboard - Ulysses CRM{% endblock %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
{# Dashboard paginator macro (Phase 8A) - uses ?page= and preserves anchors #}
{% macro dash_pager(page, has_prev, has_more, anchor_id) %}
  {% if has_prev or has_more %}
    {% set start_page = page - 2 if page - 2 > 1 else 1 %}
    {% set end_page = page + 2 if has_more else page %}

    <nav aria-label="Dashboard pagination" class="mt-2">
      <ul class="pagination pagination-sm justify-content-center mb-0">

        <li class="page-item {% if not has_prev %}disabled{% endif %}">
          <a class="page-link"
             href="{% if has_prev %}{{ url_for('dashboard', page=page-1) }}#{{ anchor_id }}{% else %}#{% endif %}">
            Prev
          </a>
        </li>

        {% for p in range(start_page, end_page + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link"
               href="{{ url_for('dashboard', page=p) }}#{{ anchor_id }}">
              {{ p }}
            </a>
          </li>
        {% endfor %}

        <li class="page-item {% if not has_more %}disabled{% endif %}">
          <a class="page-link"
             href="{% if has_more %}{{ url_for('dashboard', page=page+1) }}#{{ anchor_id }}{% else %}#{% endif %}">
            Next
          </a>
        </li>

      </ul>
    </nav>
  {% endif %}
{% endmacro %}

<div class="dashboard-scope">
  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Dashboard</h2>
      <div class="text-muted">Today: {{ today|fmt_date }}</div>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="card mt-3">
    <div class="card-body">
      <div class="row g-3">
  
        <div class="col-md-3 col-6">
        <a class="text-decoration-none text-reset" href="{{ url_for('dashboard') }}#followups-overdue">
          <div class="card text-center h-100 border-start border-2 border-danger">
            <div class="card-body">
              <div class="text-muted small">Overdue Follow Ups</div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_overdue|length }}
              </div>
            </div>
          </div>
        </a>
        </div>
  
        <div class="col-md-3 col-6">
        <a class="text-decoration-none text-reset" href="{{ url_for('dashboard') }}#followups-upcoming">
          <div class="card text-center h-100 border-start border-2 border-warning">
            <div class="card-body">
              <div class="text-muted small">
                Upcoming (next {{ upcoming_days }} days)
              </div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_upcoming|length }}
              </div>
            </div>
          </div>
        </a>
        </div>
  
        <div class="col-md-3 col-6">
        <a class="text-decoration-none text-reset" href="{{ url_for('contacts') }}">
          <div class="card text-center h-100 border-start border-2 border-success">
            <div class="card-body">
              <div class="text-muted small">Active Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ active_contacts|length }}
              </div>
            </div>
          </div>
        </a>
        </div>
  
        <div class="col-md-3 col-6">
        <a class="text-decoration-none text-reset" href="{{ url_for('contacts') }}">
          <div class="card text-center h-100 border-start border-2 border-primary">
            <div class="card-body">
              <div class="text-muted small">Total Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ total_contacts }}
              </div>
            </div>
          </div>
        </a>
        </div>
  
      </div>
    </div>
  </div>


  <!-- Tabs card -->
  <div class="card mt-3">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <ul class="nav nav-tabs border-0 mb-0" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="outreach-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#outreach"
                    type="button"
                    role="tab"
                    aria-controls="outreach"
                    aria-selected="true">
              Outreach
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="followups-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#followups"
                    type="button"
                    role="tab"
                    aria-controls="followups"
                    aria-selected="false">
              Follow-ups
            </button>
          </li>
        </ul>
        <div class="ms-3"></div>
      </div>

      <div class="tab-content" id="dashboardTabsContent">

        <!-- Outreach tab -->
        <div class="tab-pane fade show active" id="outreach" role="tabpanel" aria-labelledby="outreach-tab">
          <div class="row g-3">
          
            <!-- Card 1: Today's Snapshot -->
            <div class="col-12 col-lg-4">
            <!-- Today's Snapshot -->
            <div class="card mb-3" id="todays-snapshot">
              <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold">Today’s Snapshot</div>
                  <div class="text-muted dash-secondary d-none d-lg-block">
                    Quick hits for {{ today|fmt_date }}
                  </div>
                </div>
                <div class="d-flex gap-2">
                  <a class="btn btn-sm btn-outline-primary text-nowrap"
                     href="{{ url_for('tasks_new') }}">
                    <span class="d-inline d-sm-none">Add</span>
                    <span class="d-none d-sm-inline">Add Task</span>
                  </a>
                </div>
              </div>
            
              <div class="card-body bg-white">
              
                {% if snapshot_items and snapshot_items|length > 0 %}
                  <div class="mt-2">
              
                    {% for item in snapshot_items %}
              
                      {% if item.item_type == "followup" %}
                        <div class="dash-snap-item">
              
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
              
                              <span class="badge bg-warning-subtle text-warning-emphasis">Followup</span>
              
                              {% if item.snap_status == "overdue" %}
                                <span class="badge bg-danger-subtle text-danger-emphasis">
                                  Overdue{% if item.overdue_days is not none %} · {{ item.overdue_days }}d{% endif %}
                                </span>
                              {% else %}
                                <span class="badge bg-primary-subtle text-primary-emphasis">Due today</span>
                              {% endif %}
              
                            </div>
              
                            {% if item.get('contact_id') %}
                              <a class="small text-decoration-none"
                                 href="{{ url_for('edit_contact', contact_id=item['contact_id']) }}?engagement_id={{ item['engagement_id'] }}#pane-followups">
                                See more
                              </a>
                            {% else %}
                              <span class="small text-muted">See more</span>
                            {% endif %}
                          </div>
              
                          <div class="text-muted small mt-1">
                            {{ item.get("follow_up_due_at")|fmt_dt }}
                          </div>
              
                          <div class="fw-semibold mt-1">
                            <a class="text-decoration-none"
                               href="{{ url_for('edit_contact', contact_id=item['contact_id']) }}?engagement_id={{ item['engagement_id'] }}#pane-followups">
                              {{ item.contact_name or "Unnamed Contact" }}
                            </a>
                          </div>
              
                          {% if item.snippet %}
                            <div class="text-muted small dash-clamp-2 mt-1">{{ item.snippet }}</div>
                          {% endif %}
              
                        </div>
              
                      {% elif item.item_type == "task" %}
                        <div class="dash-snap-item">
              
                          <div class="d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-2">
              
                              <span class="badge bg-info-subtle text-info-emphasis">Task</span>
              
                              {% if item.snap_status == "overdue" %}
                                <span class="badge bg-danger-subtle text-danger-emphasis">
                                  Overdue{% if item.overdue_days is not none %} · {{ item.overdue_days }}d{% endif %}
                                </span>
                              {% else %}
                                <span class="badge bg-primary-subtle text-primary-emphasis">Due today</span>
                              {% endif %}
              
                            </div>
              
                            <a class="small text-decoration-none"
                               href="{{ url_for('tasks_view', task_id=item['task_id']) }}">
                              See more
                            </a>
                          </div>
              
                          {% if item.get("due_ts") %}
                            <div class="text-muted small mt-1">
                              {{ item.get("due_ts")|fmt_dt }}
                            </div>
                          {% endif %}
              
                          <div class="fw-semibold mt-1">{{ item.title or "Task" }}</div>
              
                          {% if item.contact_name %}
                            <div class="text-muted small">
                              {% if item.contact_id %}
                                <a class="text-decoration-none"
                                   href="{{ url_for('edit_contact', contact_id=item['contact_id']) }}#engagements">
                                  {{ item.contact_name }}
                                </a>
                              {% else %}
                                {{ item.contact_name }}
                              {% endif %}
                            </div>
                          {% endif %}
              
                          {% if item.snippet %}
                            <div class="text-muted small dash-clamp-2 mt-1">{{ item.snippet }}</div>
                          {% endif %}
              
                        </div>
                      {% endif %}
              
                    {% endfor %}
              
                  </div>
              
                  {{ dash_pager(dash_page, has_prev_snapshot, has_more_snapshot, "todays-snapshot") }}
              
                {% else %}
                  <div class="text-muted mt-2">Nothing due today.</div>
                {% endif %}
              
              </div>
            </div>    {# /Today’s Snapshot card #}
            </div>
          
            <!-- Card 2: Active Contacts (compact) -->
            <div class="col-12 col-lg-4">
              <div class="card h-100" id="active-contacts">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">Active Contacts</div>
                    <div class="text-muted small d-none d-lg-block">
                      Showing {{ active_contacts|length if active_contacts else 0 }} (max 20)
                    </div>
                  </div>
                  <a class="btn btn-sm btn-outline-primary" href="{{ url_for('contacts') }}">Contacts</a>
                </div>
            
                {# IMPORTANT: make body a flex column so the list can fill remaining height #}
                <div class="card-body bg-white">
                  {% if active_contacts and active_contacts|length > 0 %}
                    <div class="list-group list-group-flush">
                      {% for c in active_contacts %}
                        <a class="list-group-item list-group-item-action px-0"
                           href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">
                          <div class="d-flex justify-content-between align-items-start">
                            <div>
                              <div class="fw-semibold">
                                {% if c["first_name"] or c["last_name"] %}
                                  {{ (c["first_name"] or "") ~ (" " if c["first_name"] and c["last_name"] else "") ~ (c["last_name"] or "") }}
                                {% else %}
                                  {{ c["name"] or "Unnamed Contact" }}
                                {% endif %}
                              </div>
                
                              <div class="mt-1">
                                {% if c["has_buyer_profile"] %}
                                  <span class="badge bg-success-subtle text-success-emphasis">Buyer</span>
                                {% endif %}
                                {% if c["has_seller_profile"] %}
                                  <span class="badge bg-primary-subtle text-primary-emphasis">Seller</span>
                                {% endif %}
                                {% for b in c["active_reasons"][:2] %}
                                  <span class="badge bg-secondary-subtle text-secondary-emphasis">
                                    {{ b }}
                                  </span>
                                {% endfor %}
                              </div>
                            </div>
                
                            <span class="text-muted small">Open</span>
                          </div>
                        </a>
                      {% endfor %}
                    </div>
                
                    {{ dash_pager(dash_page, has_prev_active, has_more_active, "active-contacts") }}
                
                  {% else %}
                    <div class="text-muted">Nothing here.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          
            <!-- Card 3: Active Transactions (new) -->
            <div class="col-12 col-lg-4">
              <div class="card h-100" id="active-transactions">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div>
                    <div class="fw-semibold">Active Transactions</div>
                    <div class="text-muted small d-none d-lg-block">
                      {{ active_transactions_total }} active
                    </div>
                  </div>
                  <button type="button" class="btn btn-sm btn-outline-primary text-nowrap"
                          data-bs-toggle="modal" data-bs-target="#txContactPickerModal">
                    <span class="d-inline d-sm-none">Add</span>
                    <span class="d-none d-sm-inline">Add Transaction</span>
                  </button>
                </div>
          
                <div class="card-body bg-white">
                  {% if active_transactions and active_transactions|length > 0 %}
                    <div class="list-group list-group-flush">
                      {% for t in active_transactions %}
                        <a class="list-group-item list-group-item-action px-0"
                           href="{{ url_for('edit_contact', contact_id=t['contact_id']) }}?tx_id={{ t['id'] }}#transactions">
                          <div class="d-flex justify-content-between align-items-start">
                            <div class="me-2">
                              <div class="d-flex align-items-center gap-2 flex-wrap">
                                {# Transaction type badge #}
                                <span class="badge {{ tx_type_badge_class.get(t.transaction_type_key, 'bg-secondary') }}">
                                  {{ t.transaction_type_label }}
                                </span>
                
                                {# Status badge #}
                                <span class="badge {{ tx_badge_class.get(t.status, 'bg-secondary') }}">
                                  {{ tx_status_label.get(t.status, t.status) }}
                                </span>
                              </div>
                
                              <div class="text-muted small dash-clamp-2 mt-1">
                                {{ t.get('address') or 'No address yet' }}
                              </div>
                
                              {% if t.get('contact_name') %}
                                <div class="text-muted small mt-1">
                                  {{ t['contact_name'] }}
                                </div>
                              {% endif %}
                            </div>
                
                            <div class="text-end">
                              {% if t.get('expected_close_date') %}
                                <div class="small text-muted">Close</div>
                                <div class="small">{{ t['expected_close_date']|fmt_date }}</div>
                              {% else %}
                                <div class="small text-muted">Open</div>
                              {% endif %}
                            </div>
                          </div>
                        </a>
                      {% endfor %}
                    </div>
                
                    {{ dash_pager(dash_page, has_prev_tx, has_more_tx, "active-transactions") }}
                
                  {% else %}
                    <div class="text-muted">No active transactions yet.</div>
                  {% endif %}
                </div>
              </div>
            </div>
          
          </div>
        </div>

        <!-- Follow-ups tab -->
        <div class="tab-pane fade" id="followups" role="tabpanel" aria-labelledby="followups-tab">
        
          {% macro contact_display(c) %}
            {% if c.get("contact_name") %}
              {{ c["contact_name"] }}
            {% elif c.get("first_name") or c.get("last_name") %}
              {{ (c.get("first_name") or "") ~ (" " if c.get("first_name") and c.get("last_name") else "") ~ (c.get("last_name") or "") }}
            {% else %}
              {{ c.get("name") or "Unnamed Contact" }}
            {% endif %}
          {% endmacro %}
        
          {% macro followup_table(rows) %}
            {% if rows and rows|length > 0 %}
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th>
                      <th style="width: 220px;">Due</th>
                      <th>Last Engagement</th>
                      <th style="width: 220px;" class="text-end actions-col">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in rows %}
                      <tr>
                        <td>
                          <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">
                            {{ contact_display(c) }}
                          </a>
                        </td>
        
                        <td>
                          {% if c.get("follow_up_due_at") %}
                            {{ c["follow_up_due_at"]|fmt_dt }}
                          {% else %}
                            <span class="text-muted">None</span>
                          {% endif %}
                        </td>
        
                        <td style="min-width: 280px;">
                          {% if c.get("last_engagement_at") %}
                            <div class="small">
                              <strong>{{ c.get("last_engagement_type") or "engagement" }}</strong>
                              <span class="text-muted">({{ c["last_engagement_at"]|fmt_dt }})</span>
                            </div>
        
                            {% set detail = c.get("last_engagement_outcome") or c.get("last_engagement_summary") %}
                            {% if detail %}
                              <div class="text-muted small">{{ detail }}</div>
                            {% endif %}
                          {% else %}
                            <span class="text-muted small">No engagement context yet</span>
                          {% endif %}
                        </td>
        
                        <td class="text-end actions-col">
                          <div class="d-inline-flex align-items-center justify-content-end">
                            <div class="btn-group btn-group-sm" role="group" aria-label="Follow-up actions">
                              <a class="btn btn-outline-primary"
                                 href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">
                                Open
                              </a>
                        
                              {% if c.get("engagement_id") %}
                                <button type="button"
                                        class="btn btn-outline-success"
                                        onclick="document.getElementById('followupDoneForm_{{ c['engagement_id'] }}').submit();">
                                  Done
                                </button>
                              {% endif %}
                            </div>
                        
                            {% if c.get("engagement_id") %}
                              <form id="followupDoneForm_{{ c['engagement_id'] }}"
                                    method="post"
                                    action="{{ url_for('followup_clear', engagement_id=c['engagement_id']) }}"
                                    class="d-none">
                              </form>
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">Nothing here.</p>
            {% endif %}
          {% endmacro %}
        
          <!-- Anchor for Overdue -->
          <a id="followups-overdue" class="d-block" style="scroll-margin-top: 90px;"></a>
          <div class="card mb-3">
            <div class="card-header bg-danger-subtle text-dark fw-semibold">
              Overdue Follow Ups
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_overdue) }}
            </div>
          </div>
        
          <!-- Anchor for Upcoming -->
          <a id="followups-upcoming" class="d-block" style="scroll-margin-top: 90px;"></a>
          <div class="card">
            <div class="card-header bg-success-subtle text-dark fw-semibold">
              Upcoming (next {{ upcoming_days }} days)
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_upcoming) }}
            </div>
          </div>
        
        </div>

      </div>
    </div>
  </div>
  
<!-- ============================= -->
<!-- Dashboard: Add Transaction Modal -->
<!-- ============================= -->
  <div class="modal fade" id="txContactPickerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Select a contact</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
  
        <div class="modal-body">
            <label class="form-label" for="txContactSearchInput">Search contact</label>
            <input type="text"
                   id="txContactSearchInput"
                   class="form-control"
                   placeholder="Start typing a name..."
                   autocomplete="off">
            
            <div class="mt-2 list-group" id="txContactSearchResults" style="max-height: 260px; overflow:auto;">
              <!-- results injected here -->
            </div>
            
            <input type="hidden" id="txContactSelectedId" value="">
            <div class="form-text mt-2" id="txContactSelectedLabel">
              Select a contact to continue.
            </div>
          <div class="form-text mt-2">
            You will be taken to that contact’s “New Transaction” form.
          </div>
        </div>
  
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-primary" id="txContactPickerGo" disabled>
            Continue
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var more = document.getElementById("recentEngagementsMore");
      var btn = document.getElementById("recentEngagementsToggle");
      if (!more || !btn) return;

      more.addEventListener("shown.bs.collapse", function () {
        btn.textContent = "See less";
      });
      more.addEventListener("hidden.bs.collapse", function () {
        var remaining = btn.getAttribute("data-remaining");
        if (remaining) btn.textContent = "See more (" + remaining + ")";
      });

      var match = btn.textContent.match(/\((\d+)\)/);
      if (match && match[1]) btn.setAttribute("data-remaining", match[1]);
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".js-toggle-text").forEach(function (a) {
        var targetSel = a.getAttribute("href");
        if (!targetSel) return;
        var target = document.querySelector(targetSel);
        if (!target) return;

        target.addEventListener("shown.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-less") || "See less";
            link.setAttribute("aria-expanded", "true");
          });
        });

        target.addEventListener("hidden.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-more") || "See more";
            link.setAttribute("aria-expanded", "false");
          });
        });
      });
    });
  </script>
  <script>
    window.addEventListener("load", function () {
      function getTabButton(tabTarget) {
        return document.querySelector(
          'button[data-bs-toggle="tab"][data-bs-target="' + tabTarget + '"]'
        );
      }
  
      function showTab(tabTarget) {
        var btn = getTabButton(tabTarget);
        if (!btn || !window.bootstrap) return null;
        bootstrap.Tab.getOrCreateInstance(btn).show();
        return btn;
      }
  
      function scrollToHash(hash) {
        if (!hash || hash === "#followups" || hash === "#outreach") return;
        var target = document.querySelector(hash);
        if (target) target.scrollIntoView({ behavior: "smooth", block: "start" });
      }
  
      function handleHash() {
        var hash = window.location.hash || "";
        if (!hash) return;
  
        // Follow-ups hashes
        if (hash === "#followups" || hash.startsWith("#followups-")) {
          var followupsBtn = showTab("#followups");
          if (!followupsBtn) return;
  
          // After the tab is shown, scroll to the anchor
          if (hash.startsWith("#followups-")) {
            followupsBtn.addEventListener(
              "shown.bs.tab",
              function () {
                scrollToHash(hash);
              },
              { once: true }
            );
          }
          return;
        }
  
        // Outreach tab (optional)
        if (hash === "#outreach") {
          showTab("#outreach");
          return;
        }
      }
  
      // On load
      handleHash();
  
      // If hash changes
      window.addEventListener("hashchange", handleHash);
  
      // When user clicks a tab, persist it in the URL
      document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(function (btn) {
        btn.addEventListener("shown.bs.tab", function (e) {
          var target = e.target.getAttribute("data-bs-target");
          if (target) history.replaceState(null, "", target);
        });
      });
    });
  </script>

  <script>
  (function () {
    const input = document.getElementById("txContactSearchInput");
    const results = document.getElementById("txContactSearchResults");
    const selectedIdEl = document.getElementById("txContactSelectedId");
    const selectedLabel = document.getElementById("txContactSelectedLabel");
    const go = document.getElementById("txContactPickerGo");
  
    if (!input || !results || !selectedIdEl || !selectedLabel || !go) return;
  
    // Build a small in-memory index from server-provided contacts
    const contacts = [
      {% for c in dashboard_contact_picker %}
        { id: {{ c.id }}, name: {{ c.display_name|tojson }} },
      {% endfor %}
    ];
  
    function setSelected(contact) {
      selectedIdEl.value = contact.id;
      selectedLabel.textContent = "Selected: " + contact.name;
      go.disabled = false;
  
      // Highlight selection
      Array.from(results.querySelectorAll(".list-group-item")).forEach(el => {
        el.classList.toggle("active", el.dataset.id === String(contact.id));
      });
    }
  
    function clearSelected() {
      selectedIdEl.value = "";
      selectedLabel.textContent = "Select a contact to continue.";
      go.disabled = true;
    }
  
    function render(query) {
      const q = (query || "").trim().toLowerCase();
      results.innerHTML = "";
  
      if (!q) {
        clearSelected();
        return;
      }
  
      // Simple substring match; keep it small and fast
      const matches = contacts
        .filter(c => c.name.toLowerCase().includes(q))
        .slice(0, 12);
  
      if (matches.length === 0) {
        clearSelected();
        const empty = document.createElement("div");
        empty.className = "list-group-item text-muted";
        empty.textContent = "No matches.";
        results.appendChild(empty);
        return;
      }
  
      matches.forEach(c => {
        const a = document.createElement("button");
        a.type = "button";
        a.className = "list-group-item list-group-item-action";
        a.dataset.id = String(c.id);
        a.textContent = c.name;
        a.addEventListener("click", () => setSelected(c));
        results.appendChild(a);
      });
  
      // Do not auto-select; user clicks to confirm
      clearSelected();
    }
  
    input.addEventListener("input", (e) => render(e.target.value));
  
    go.addEventListener("click", function () {
      const id = selectedIdEl.value;
      if (!id) return;
      const nextUrl = encodeURIComponent("{{ url_for('dashboard') }}");
      window.location.href = `/contacts/${id}/transactions/new?next=${nextUrl}`;
    });
  
    // Optional: clear on modal open so it feels fresh each time
    const modalEl = document.getElementById("txContactPickerModal");
    if (modalEl) {
      modalEl.addEventListener("shown.bs.modal", () => {
        input.value = "";
        results.innerHTML = "";
        clearSelected();
        input.focus();
      });
    }
  })();
  </script>
<style>
  /* Fill the available card-body height and scroll only when needed */
  .active-contacts-scroll {
    min-height: 0;        /* critical: enables overflow scrolling inside a flex parent */
    overflow-y: auto;     /* scroll appears only when content overflows */
  }
</style>
  
</div>
{% endblock %}
