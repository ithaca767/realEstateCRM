{% extends "base.html" %}

{% block title %}Dashboard - Ulysses CRM{% endblock %}

{% block content %}

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Dashboard</h2>
      <div class="text-muted">Today: {{ today }}</div>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="card mt-3">
    <div class="card-body">
      <div class="row g-3">
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-danger">
            <div class="card-body">
              <div class="text-muted small">Overdue Follow Ups</div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_overdue|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-warning">
            <div class="card-body">
              <div class="text-muted small">
                Upcoming (next {{ upcoming_days }} days)
              </div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_upcoming|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-success">
            <div class="card-body">
              <div class="text-muted small">Active Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ active_contacts|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-primary">
            <div class="card-body">
              <div class="text-muted small">Total Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ total_contacts }}
              </div>
            </div>
          </div>
        </div>
  
      </div>
    </div>
  </div>


  <!-- Tabs card -->
  <div class="card mt-3">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <ul class="nav nav-tabs border-0 mb-0" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="outreach-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#outreach"
                    type="button"
                    role="tab"
                    aria-controls="outreach"
                    aria-selected="true">
              Outreach
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="followups-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#followups"
                    type="button"
                    role="tab"
                    aria-controls="followups"
                    aria-selected="false">
              Follow-ups
            </button>
          </li>
        </ul>
        <div class="ms-3"></div>
      </div>

      <div class="tab-content" id="dashboardTabsContent">

        <!-- Outreach tab -->
        <div class="tab-pane fade show active" id="outreach" role="tabpanel" aria-labelledby="outreach-tab">
          <div class="row g-3">

            <!-- Active Contacts -->
            <div class="col-lg-8">
              <div class="card">
                <div class="card-header">
                  <div>
                    <div class="fw-semibold">Active Contacts</div>
                    <div class="text-muted small">
                      Active if engaged in last {{ active_days }} days, has a follow-up, buyer profile, or seller profile
                    </div>
                  </div>
                </div>

                <div class="card-body bg-white">
                  {% if active_contacts and active_contacts|length > 0 %}
                    <div class="table-responsive">
                      <table class="table table-sm table-striped mb-0 align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>Name</th>
                            <th>Why</th>
                            <th>Next Follow-up</th>
                            <th>Last Engagement</th>
                            <th style="width: 140px;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for c in active_contacts %}
                            <tr>
                              <td>
                                <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">                                  {% if c["first_name"] or c["last_name"] %}
                                    {{ (c["first_name"] or "") ~ (" " if c["first_name"] and c["last_name"] else "") ~ (c["last_name"] or "") }}
                                  {% else %}
                                    {{ c["name"] or "Unnamed Contact" }}
                                  {% endif %}
                                </a>

                                <div class="text-muted small mt-1">
                                  {% if c["has_buyer_profile"] and c["has_seller_profile"] %}
                                    <span class="badge bg-info text-dark me-1">Buyer</span>
                                    <span class="badge bg-warning text-dark">Seller</span>
                                  {% elif c["has_buyer_profile"] %}
                                    <span class="badge bg-info text-dark">Buyer</span>
                                  {% elif c["has_seller_profile"] %}
                                    <span class="badge bg-warning text-dark">Seller</span>
                                  {% endif %}
                                </div>
                              </td>

                              <td style="min-width: 220px;">
                                {% if c["active_reasons"] %}
                                  {% for b in c["active_reasons"] %}
                                    <span class="badge bg-secondary me-1 mb-1">{{ b }}</span>
                                  {% endfor %}
                                {% else %}
                                  <span class="text-muted small">Active</span>
                                {% endif %}
                              </td>

                              <td style="min-width: 160px;">
                                {% if c["next_follow_up"] %}
                                  <div>{{ c["next_follow_up"] }}</div>
                                  {% if c["next_follow_up_time"] %}
                                    <div class="text-muted small">{{ c["next_follow_up_time"] }}</div>
                                  {% endif %}
                                {% else %}
                                  <span class="text-muted small">None</span>
                                {% endif %}
                              </td>

                              <td style="min-width: 260px;">
                                {% if c["last_engagement_at"] %}
                                  <div class="small">
                                    <strong>{{ c["last_engagement_type"] or "engagement" }}</strong>
                                    <span class="text-muted">({{ c["last_engagement_at"] }})</span>
                                  </div>

                                  {% set detail = c["last_engagement_outcome"] or c["last_engagement_summary"] %}
                                  {% if detail %}
                                    {% set collapse_id = "acEngDetail" ~ c["contact_id"] %}
                                    <div class="text-muted small">
                                      <a class="text-decoration-none"
                                         data-bs-toggle="collapse"
                                         href="#{{ collapse_id }}"
                                         role="button"
                                         aria-expanded="false"
                                         aria-controls="{{ collapse_id }}">
                                        Details
                                      </a>
                                    </div>
                                    <div class="collapse mt-1" id="{{ collapse_id }}">
                                      <div class="small">{{ detail }}</div>
                                    </div>
                                  {% endif %}
                                {% else %}
                                  <span class="text-muted small">No engagements yet</span>
                                {% endif %}
                              </td>

                              <td>
                                <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements"
                                   class="btn btn-sm btn-outline-primary">
                                  Open
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <p class="mb-0 text-muted">Nothing here.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Recent Engagements -->
            <div class="col-lg-4">
              <div class="card">
                <div class="card-header">
                  <div class="fw-semibold">Recent Engagements</div>
                  <div class="text-muted small">Last 10</div>
                </div>

                <div class="card-body bg-white">
                  {% set show_n = 5 %}
                  {% set total_n = recent_engagements|length %}

                  {% if recent_engagements and total_n > 0 %}
                    <div class="list-group list-group-flush">
                      {% for e in recent_engagements[:show_n] %}
                        <div class="list-group-item px-0">
                          <div class="d-flex justify-content-between">
                            <div>
                              <a href="{{ url_for('edit_contact', contact_id=e['contact_id']) }}#engagements" class="text-decoration-none">
                                <strong>{{ e["contact_name"] or "Unnamed Contact" }}</strong>
                              </a>
                              <div class="text-muted small">{{ e["engagement_type"] or "engagement" }}</div>
                            </div>
                            <div class="text-muted small">{{ e["occurred_at"] }}</div>
                          </div>

                          {% set detail = e["outcome"] or e["summary_clean"] %}
                          {% if detail %}
                            {% set collapse_id = "reDetail" ~ e["id"] %}
                            {% set preview_len = 120 %}
                            {% if detail|length > preview_len %}
                              <div class="small mt-1">
                                {{ detail[:preview_len] }}...
                                <a href="#{{ collapse_id }}"
                                   class="ms-1 text-decoration-none js-toggle-text"
                                   data-bs-toggle="collapse"
                                   role="button"
                                   aria-expanded="false"
                                   aria-controls="{{ collapse_id }}"
                                   data-more="See more"
                                   data-less="See less">
                                  See more
                                </a>
                              </div>

                              <div class="collapse mt-1" id="{{ collapse_id }}">
                                <div class="small">{{ detail }}</div>
                                <a href="#{{ collapse_id }}"
                                   class="text-decoration-none js-toggle-text"
                                   data-bs-toggle="collapse"
                                   role="button"
                                   aria-expanded="true"
                                   aria-controls="{{ collapse_id }}"
                                   data-more="See more"
                                   data-less="See less">
                                  See less
                                </a>
                              </div>
                            {% else %}
                              <div class="small mt-1">{{ detail }}</div>
                            {% endif %}
                          {% endif %}
                        </div>
                      {% endfor %}

                      {% if total_n > show_n %}
                        <div class="collapse" id="recentEngagementsMore">
                          {% for e in recent_engagements[show_n:] %}
                            <div class="list-group-item px-0">
                              <div class="d-flex justify-content-between">
                                <div>
                                  <a href="{{ url_for('edit_contact', contact_id=e['contact_id']) }}#engagements" class="text-decoration-none">
                                    <strong>{{ e["contact_name"] or "Unnamed Contact" }}</strong>
                                  </a>
                                  <div class="text-muted small">{{ e["engagement_type"] or "engagement" }}</div>
                                </div>
                                <div class="text-muted small">{{ e["occurred_at"] }}</div>
                              </div>

                              {% if e["outcome"] %}
                                <div class="small mt-1">{{ e["outcome"] }}</div>
                              {% elif e["summary_clean"] %}
                                <div class="small mt-1">{{ e["summary_clean"] }}</div>
                              {% endif %}
                            </div>
                          {% endfor %}
                        </div>

                        <div class="pt-2">
                          <button class="btn btn-sm btn-outline-secondary"
                                  type="button"
                                  data-bs-toggle="collapse"
                                  data-bs-target="#recentEngagementsMore"
                                  aria-expanded="false"
                                  aria-controls="recentEngagementsMore"
                                  id="recentEngagementsToggle">
                            See more ({{ total_n - show_n }})
                          </button>
                        </div>
                      {% endif %}
                    </div>
                  {% else %}
                    <p class="mb-0 text-muted">Nothing here.</p>
                  {% endif %}
                </div>
              </div>
            </div>

          </div>
        </div>

        <!-- Follow-ups tab -->
        <div class="tab-pane fade" id="followups" role="tabpanel" aria-labelledby="followups-tab">

          {% macro followup_table(rows) %}
            {% if rows and rows|length > 0 %}
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Last Engagement</th>
                      <th style="width: 140px;">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in rows %}
                      <tr>
                        <td>
                          <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">                            {% if c["first_name"] or c["last_name"] %}
                              {{ (c["first_name"] or "") ~ (" " if c["first_name"] and c["last_name"] else "") ~ (c["last_name"] or "") }}
                            {% else %}
                              {{ c["name"] or "Unnamed Contact" }}
                            {% endif %}
                          </a>
                        </td>
                        <td>{{ c["follow_up_due_at"] or "" }}</td>
                        <td></td>

                        <td style="min-width: 280px;">
                          {% if c["last_engagement_at"] %}
                            <div class="small">
                              <strong>{{ c["last_engagement_type"] or "engagement" }}</strong>
                              <span class="text-muted">({{ c["last_engagement_at"] }})</span>
                            </div>
                            {% if c["last_engagement_outcome"] %}
                              <div class="text-muted small">{{ c["last_engagement_outcome"] }}</div>
                            {% elif c["last_engagement_summary"] %}
                              <div class="text-muted small">{{ c["last_engagement_summary"] }}</div>
                            {% endif %}
                          {% else %}
                            <span class="text-muted small">No engagement context yet</span>
                          {% endif %}
                        </td>

                        <td>
                          <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements"
                             class="btn btn-sm btn-outline-primary">
                            Open
                          </a>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">Nothing here.</p>
            {% endif %}
          {% endmacro %}

          <div class="card mb-3">
            <div class="card-header bg-danger-subtle text-dark fw-semibold">
              Overdue Follow Ups
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_overdue) }}
            </div>
          </div>
          
          <div class="card">
            <div class="card-header bg-success-subtle text-dark fw-semibold">
              Upcoming (next {{ upcoming_days }} days)
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_upcoming) }}
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var more = document.getElementById("recentEngagementsMore");
      var btn = document.getElementById("recentEngagementsToggle");
      if (!more || !btn) return;

      more.addEventListener("shown.bs.collapse", function () {
        btn.textContent = "See less";
      });
      more.addEventListener("hidden.bs.collapse", function () {
        var remaining = btn.getAttribute("data-remaining");
        if (remaining) btn.textContent = "See more (" + remaining + ")";
      });

      var match = btn.textContent.match(/\((\d+)\)/);
      if (match && match[1]) btn.setAttribute("data-remaining", match[1]);
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".js-toggle-text").forEach(function (a) {
        var targetSel = a.getAttribute("href");
        if (!targetSel) return;
        var target = document.querySelector(targetSel);
        if (!target) return;

        target.addEventListener("shown.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-less") || "See less";
            link.setAttribute("aria-expanded", "true");
          });
        });

        target.addEventListener("hidden.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-more") || "See more";
            link.setAttribute("aria-expanded", "false");
          });
        });
      });
    });
  </script>

{% endblock %}
