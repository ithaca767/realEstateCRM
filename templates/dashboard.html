{% extends "base.html" %}

{% block title %}Dashboard - Ulysses CRM{% endblock %}

{% block content %}
{# Dashboard paginator macro (Phase 6c) #}
{% macro dash_pager(page, has_prev, has_more, anchor_id) %}
  {% if has_prev or has_more %}
    {% set start_page = page - 2 if page - 2 > 1 else 1 %}
    {% set end_page = page + 2 if has_more else page %}

    <nav aria-label="Dashboard pagination" class="mt-2">
      <ul class="pagination pagination-sm justify-content-center mb-0">
        <li class="page-item {% if not has_prev %}disabled{% endif %}">
          <a class="page-link"
             href="{% if has_prev %}{{ url_for('dashboard', ac_page=page-1) }}#{{ anchor_id }}{% else %}#{% endif %}">
            Prev
          </a>
        </li>

        {% for p in range(start_page, end_page + 1) %}
          <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link"
               href="{{ url_for('dashboard', ac_page=p) }}#{{ anchor_id }}">
              {{ p }}
            </a>
          </li>
        {% endfor %}

        <li class="page-item {% if not has_more %}disabled{% endif %}">
          <a class="page-link"
             href="{% if has_more %}{{ url_for('dashboard', ac_page=page+1) }}#{{ anchor_id }}{% else %}#{% endif %}">
            Next
          </a>
        </li>
      </ul>
    </nav>
  {% endif %}
{% endmacro %}

  <!-- Page header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div>
      <h2 class="mb-0">Dashboard</h2>
      <div class="text-muted">Today: {{ today }}</div>
    </div>
  </div>

  <!-- Summary cards -->
  <div class="card mt-3">
    <div class="card-body">
      <div class="row g-3">
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-danger">
            <div class="card-body">
              <div class="text-muted small">Overdue Follow Ups</div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_overdue|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-warning">
            <div class="card-body">
              <div class="text-muted small">
                Upcoming (next {{ upcoming_days }} days)
              </div>
              <div class="fs-4 fw-bold text-dark">
                {{ followups_upcoming|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-success">
            <div class="card-body">
              <div class="text-muted small">Active Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ active_contacts|length }}
              </div>
            </div>
          </div>
        </div>
  
        <div class="col-md-3 col-6">
          <div class="card text-center h-100 border-start border-2 border-primary">
            <div class="card-body">
              <div class="text-muted small">Total Contacts</div>
              <div class="fs-4 fw-bold text-dark">
                {{ total_contacts }}
              </div>
            </div>
          </div>
        </div>
  
      </div>
    </div>
  </div>


  <!-- Tabs card -->
  <div class="card mt-3">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
        <ul class="nav nav-tabs border-0 mb-0" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active"
                    id="outreach-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#outreach"
                    type="button"
                    role="tab"
                    aria-controls="outreach"
                    aria-selected="true">
              Outreach
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link"
                    id="followups-tab"
                    data-bs-toggle="tab"
                    data-bs-target="#followups"
                    type="button"
                    role="tab"
                    aria-controls="followups"
                    aria-selected="false">
              Follow-ups
            </button>
          </li>
        </ul>
        <div class="ms-3"></div>
      </div>

      <div class="tab-content" id="dashboardTabsContent">

        <!-- Outreach tab -->
        <div class="tab-pane fade show active" id="outreach" role="tabpanel" aria-labelledby="outreach-tab">
          <div class="row g-3">
        
            <!-- LEFT COLUMN -->
            <div class="col-12 col-lg-8">
        
              <!-- Active Contacts -->
              <div class="card" id="active-contacts">
                <div class="card-header">
                  <div>
                    <div class="fw-semibold">Active Contacts</div>
                    <div class="text-muted small">
                      Active if engaged in last {{ active_days }} days, has a follow-up, buyer profile, or seller profile
                    </div>
                  </div>
                </div>
              
                <div class="card-body bg-white">
                  {% if active_contacts and active_contacts|length > 0 %}
                    <div class="table-responsive">
                      <table class="table table-sm table-striped mb-0 align-middle">
                        <thead class="table-light">
                          <tr>
                            <th>Name</th>
                            <th>Outreach</th>
                            <th style="width: 140px;">Actions</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for c in active_contacts %}
                            <tr>
                              <td>
                                <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">
                                  {% if c["first_name"] or c["last_name"] %}
                                    {{ (c["first_name"] or "") ~ (" " if c["first_name"] and c["last_name"] else "") ~ (c["last_name"] or "") }}
                                  {% else %}
                                    {{ c["name"] or "Unnamed Contact" }}
                                  {% endif %}
                                </a>
              
                                <div class="text-muted small mt-1">
                                  {% if c["has_buyer_profile"] %}
                                    <span class="badge bg-info text-dark">Buyer</span>
                                  {% endif %}
                                  {% if c["has_seller_profile"] %}
                                    <span class="badge bg-warning text-dark">Seller</span>
                                  {% endif %}
                                </div>
                              </td>
              
                              <td>
                                {% for b in c["active_reasons"] %}
                                  <span class="badge bg-secondary me-1">{{ b }}</span>
                                {% endfor %}
                              </td>
              
                              <td>
                                <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements"
                                   class="btn btn-sm btn-outline-primary">
                                  Open
                                </a>
                              </td>
                            </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
              
                  {{ dash_pager(ac_page, has_prev_active, has_more_active, 'active-contacts') }}
                  
                  {% else %}
                    <p class="mb-0 text-muted">Nothing here.</p>
                  {% endif %}
                </div>
              </div>
              
              <!-- Past Clients -->
              <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Past Clients</div>
                  <a class="btn btn-sm btn-outline-secondary"
                     href="{{ url_for('contacts', tab='past_clients') }}">
                    View all
                  </a>
                </div>
        
                <div class="card-body p-0">
                  {% if past_clients and past_clients|length > 0 %}
                    <div class="list-group list-group-flush">
                      {% for pc in past_clients %}
                        <a class="list-group-item list-group-item-action d-flex justify-content-between"
                           href="{{ url_for('edit_contact', contact_id=pc['contact_id']) }}#engagements">
                          <div>
                            <div class="fw-semibold">
                              {{ pc["name"] or "(Unnamed)" }}
                            </div>
                            <div class="text-muted small">
                              Last engagement: {{ pc["last_engagement_at"] or "—" }}
                            </div>
                          </div>
                          <div class="small text-muted">
                            {{ pc["next_follow_up"] or "No follow-up" }}
                          </div>
                        </a>
                      {% endfor %}
                    </div>
                  {% else %}
                    <div class="p-3 text-muted">No past clients found.</div>
                  {% endif %}
                </div>
              </div>
        
            </div> <!-- /LEFT COLUMN -->
        
            <!-- RIGHT COLUMN -->
            <div class="col-12 col-lg-4">
        
              <!-- Recent Engagements -->
              <div class="card">
                <div class="card-header">
                  <div class="fw-semibold">Recent Engagements</div>
                  <div class="text-muted small">Last 10</div>
                </div>
        
                <div class="card-body bg-white">
                  {% if recent_engagements %}
                    <div class="list-group list-group-flush">
                      {% for e in recent_engagements[:5] %}
                        <div class="list-group-item px-0">
                          <strong>{{ e["contact_name"] }}</strong>
                          {% if e["pipeline_stage"] == "Past Client / Relationship" %}
                            <span class="past-client-dot ms-2">P</span>
                          {% endif %}
                          <div class="text-muted small">
                            {{ e["engagement_type"] }} · {{ e["occurred_at"] }}
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  {% else %}
                    <p class="mb-0 text-muted">Nothing here.</p>
                  {% endif %}
                </div>
              </div>
              
              <div class="card mt-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <div class="fw-semibold">Professionals</div>
                  <span class="text-muted small">Coming soon</span>
                </div>
                <div class="card-body text-muted">
                  This section will show your top professionals and quick actions.
                </div>
              </div>
        
            </div> <!-- /RIGHT COLUMN -->
        
          </div>
        </div>

        <!-- Follow-ups tab -->
        <div class="tab-pane fade" id="followups" role="tabpanel" aria-labelledby="followups-tab">

          {% macro contact_display(c) %}
            {% if c.get("contact_name") %}
              {{ c["contact_name"] }}
            {% elif c.get("first_name") or c.get("last_name") %}
              {{ (c.get("first_name") or "") ~ (" " if c.get("first_name") and c.get("last_name") else "") ~ (c.get("last_name") or "") }}
            {% else %}
              {{ c.get("name") or "Unnamed Contact" }}
            {% endif %}
          {% endmacro %}

          {% macro followup_table(rows) %}
            {% if rows and rows|length > 0 %}
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0 align-middle">
                  <thead class="table-light">
                    <tr>
                      <th>Name</th>
                      <th style="width: 220px;">Due</th>
                      <th>Last Engagement</th>
                      <th style="width: 220px;" class="text-end">Actions</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for c in rows %}
                      <tr>
                        <td>
                          <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements">
                            {{ contact_display(c) }}
                          </a>
                        </td>

                        <td>
                          {% if c.get("follow_up_due_at") %}
                            {{ c["follow_up_due_at"] }}
                          {% else %}
                            <span class="text-muted">None</span>
                          {% endif %}
                        </td>

                        <td style="min-width: 280px;">
                          {% if c.get("last_engagement_at") %}
                            <div class="small">
                              <strong>{{ c.get("last_engagement_type") or "engagement" }}</strong>
                              <span class="text-muted">({{ c["last_engagement_at"] }})</span>
                            </div>

                            {% set detail = c.get("last_engagement_outcome") or c.get("last_engagement_summary") %}
                            {% if detail %}
                              <div class="text-muted small">{{ detail }}</div>
                            {% endif %}
                          {% else %}
                            <span class="text-muted small">No engagement context yet</span>
                          {% endif %}
                        </td>

                        <td class="text-end">
                          <div class="d-flex justify-content-end gap-2">
                            <a href="{{ url_for('edit_contact', contact_id=c['contact_id']) }}#engagements"
                               class="btn btn-sm btn-outline-primary">
                              Open
                            </a>

                            {% if c.get("engagement_id") %}
                              <form method="post" action="{{ url_for('followup_clear', engagement_id=c['engagement_id']) }}">
                                <button type="submit" class="btn btn-sm btn-outline-success">
                                  Done
                                </button>
                              </form>
                            {% endif %}
                          </div>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% else %}
              <p class="mb-0 text-muted">Nothing here.</p>
            {% endif %}
          {% endmacro %}

          <div class="card mb-3">
            <div class="card-header bg-danger-subtle text-dark fw-semibold">
              Overdue Follow Ups
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_overdue) }}
            </div>
          </div>

          <div class="card">
            <div class="card-header bg-success-subtle text-dark fw-semibold">
              Upcoming (next {{ upcoming_days }} days)
            </div>
            <div class="card-body bg-white">
              {{ followup_table(followups_upcoming) }}
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var more = document.getElementById("recentEngagementsMore");
      var btn = document.getElementById("recentEngagementsToggle");
      if (!more || !btn) return;

      more.addEventListener("shown.bs.collapse", function () {
        btn.textContent = "See less";
      });
      more.addEventListener("hidden.bs.collapse", function () {
        var remaining = btn.getAttribute("data-remaining");
        if (remaining) btn.textContent = "See more (" + remaining + ")";
      });

      var match = btn.textContent.match(/\((\d+)\)/);
      if (match && match[1]) btn.setAttribute("data-remaining", match[1]);
    });
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      document.querySelectorAll(".js-toggle-text").forEach(function (a) {
        var targetSel = a.getAttribute("href");
        if (!targetSel) return;
        var target = document.querySelector(targetSel);
        if (!target) return;

        target.addEventListener("shown.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-less") || "See less";
            link.setAttribute("aria-expanded", "true");
          });
        });

        target.addEventListener("hidden.bs.collapse", function () {
          document.querySelectorAll('a.js-toggle-text[href="' + targetSel + '"]').forEach(function (link) {
            link.textContent = link.getAttribute("data-more") || "See more";
            link.setAttribute("aria-expanded", "false");
          });
        });
      });
    });
  </script>

{% endblock %}
